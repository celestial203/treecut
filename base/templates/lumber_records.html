{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CENRO Argao - Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <style>
        body {
            background: #ffffff;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
        }
        
        table thead th {
            font-weight: 500;
            color: #374151;
            text-transform: uppercase;
            font-size: 0.875rem;
            letter-spacing: 0.05em;
        }
        
        table tbody td {
            font-size: 0.875rem;
            color: #4B5563;
        }
        
        /* Status-based row styling */
        tr.active-record {
            background-color: transparent !important;
        }
        
        tr.expired-record {
            background-color: transparent !important;
        }
        
        tr.expiring-soon-record {
            background-color: transparent !important;
        }
        
        /* Alternating row colors - changed from green to gray */
        tbody tr:nth-child(even) {
            background-color: #f9fafb; /* Light gray instead of mint green */
        }
        
        tbody tr:nth-child(odd) {
            background-color: #ffffff; /* White */
        }
        
        /* Hover effects - changed from green to gray */
        tbody tr:hover {
            background-color: #f3f4f6 !important; /* Light gray instead of mint green */
            transition: background-color 0.2s ease;
        }
        
        /* Transition effects for tbody rows */
        tbody tr {
            transition: background-color 0.2s ease;
        }
        
        /* Add these new styles */
        .context-menu {
            position: fixed;
            background: white;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            padding: 8px 0;
            z-index: 1000;
        }

        .context-menu-item {
            padding: 8px 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .context-menu-item:hover {
            background-color: #f3f4f6;
        }
    </style>
</head>
<body class="font-inter text-gray-900">
    <!-- Navigation Bar -->
    <nav class="bg-transparent shadow-lg border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center">
                    <!-- Logo -->
                    <div class="flex-shrink-0">
                        <span class="text-xl font-bold text-green-700">FUS-CENRO-ARGAO</span>
                    </div>
                </div>
                <!-- User Menu -->
                <div class="hidden md:flex items-center space-x-4">
                    <!-- Add notification bell before the welcome message -->
                    <div class="relative" id="notification-container">
                        <button class="text-gray-600 hover:text-gray-800 focus:outline-none" id="notification-button">
                            <div class="relative">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path>
                                </svg>
                                <span id="notification-badge" class="hidden absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center">0</span>
                            </div>
                        </button>
                        
                        <!-- Notification dropdown -->
                        <div id="notification-dropdown" class="hidden absolute right-0 mt-2 w-80 bg-white rounded-lg shadow-xl border border-gray-200 z-50">
                            <div class="p-4">
                                <h3 class="text-lg font-semibold text-gray-900 mb-2">Expiring Records</h3>
                                <div id="notification-list" class="space-y-3 max-h-96 overflow-y-auto">
                                    <!-- Notifications will be inserted here -->
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="text-lg text-gray-900 font-medium">
                        Welcome, {{ request.user.username }}
                    </div>
                    <div class="relative">
                        <button class="text-lg text-blue-600 hover:text-blue-800 transition duration-200 focus:outline-none" id="user-menu-button" aria-expanded="false" aria-haspopup="true">
                            â–¼
                        </button>
                        <div class="absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg z-20 hidden" id="user-menu">
                            <div class="py-1" role="menu" aria-orientation="vertical" aria-labelledby="user-menu-button">
                               
                                <!-- Quick Actions -->
                                <a href="{% url 'homepage' %}" class="block px-4 py-2 text-sm text-blue-700 hover:bg-gray-100">HOME</a>
                                <div class="px-4 py-2 text-sm text-black-800">Quick Actions</div>
                                <div class="grid grid-cols-1 gap-2">
                                    <a href="{% url 'lumber-dash' %}" class="block px-4 py-2 text-sm text-green-700 hover:bg-gray-100">DASHBOARD</a>
                                    <div class="relative group">
                                        <a href="{% url 'cutting' %}" class="block px-4 py-2 text-sm text-green-700 hover:bg-gray-100">CUTTING</a>
                                        <div class="absolute left-0 mt-0 w-48 bg-white rounded-md shadow-lg z-30 hidden group-hover:block">
                                            <a href="{% url 'cutting_records' %}" class="block px-4 py-2 text-sm text-green-700 hover:bg-gray-100">View Records</a>
                                            <a href="{% url 'trees' %}" class="block px-4 py-2 text-sm text-green-700 hover:bg-gray-100">View Trees</a>
                                        </div>
                                    </div>
                                    <a href="{% url 'lumber' %}" class="block px-4 py-2 text-sm text-green-700 hover:bg-gray-100">LUMBER </a>
                                    <a href="{% url 'chainsaw' %}" class="block px-4 py-2 text-sm text-green-700 hover:bg-gray-100">CHAINSAW</a>
                                    <a href="{% url 'wood' %}" class="block px-4 py-2 text-sm text-green-700 hover:bg-gray-100">WPP</a>

                                </div>
                                <a href="{% url 'logout' %}" class="block px-4 py-2 text-sm text-black-900 hover:bg-gray-100" role="menuitem">
                                    <svg class="inline w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 12H8m8 0l-4-4m4 4l-4 4"></path>
                                    </svg>
                                    Sign Out
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Mobile Menu Button -->
                <div class="md:hidden">
                    <button class="text-gray-500 hover:text-gray-700 focus:outline-none" id="mobile-menu-button">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4h18M3 8h18M3 12h18M3 16h18M3 20h18"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6l8 8 8-8"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v18"></path>
                        </svg>
                    </button>
                    </button>
                </div>
            </div>
        </div>
        <!-- Mobile Menu -->
        <div class="md:hidden" id="mobile-menu" style="display: none;">
            <div class="px-2 pt-2 pb-3 space-y-1">
                <a href="{% url 'logout' %}" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Sign Out</a>
            </div>
        </div>
    </nav>

    <!-- Quick Access Boxes -->
  <div class="max-w-[95%] mx-auto px-4 sm:px-6 lg:px-8 pt-4">
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
        <!-- Lumber Records Box -->
        <a href="{% url 'chainsaw_record' %}" class="block p-4 bg-white border-2 border-green-500 rounded-lg shadow hover:shadow-lg transition-shadow duration-300">
            <div class="flex items-center justify-between">
                <div>
                    <h3 class="text-base font-semibold text-gray-900">Chainsaw Records</h3>
                    <p class="text-xs text-gray-600">View chainsaw records</p>
                </div>
                <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                </svg>
            </div>
        </a>

        <!-- Cutting Records Box -->
        <a href="{% url 'cutting_records' %}" class="block p-4 bg-white border-2 border-green-500 rounded-lg shadow hover:shadow-lg transition-shadow duration-300">
            <div class="flex items-center justify-between">
                <div>
                    <h3 class="text-base font-semibold text-gray-900">Cutting Records</h3>
                    <p class="text-xs text-gray-600">View cutting records</p>
                </div>
                <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"/>
                </svg>
            </div>
        </a>

        <!-- WPP Records Box -->
        <a href="{% url 'wood_records' %}" class="block p-4 bg-white border-2 border-green-500 rounded-lg shadow hover:shadow-lg transition-shadow duration-300">
            <div class="flex items-center justify-between">
                <div>
                    <h3 class="text-base font-semibold text-gray-900">WPP Records</h3>
                    <p class="text-xs text-gray-600">View WPP records</p>
                </div>
                <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/>
                </svg>
            </div>
        </a>
    </div>
    
    <!-- Green Divider Line -->
    <div class="border-b-2 border-green-500 my-6"></div>
</div>

    <!-- Search Section -->
    <div class="max-w-[95%] mx-auto px-4 sm:px-6 lg:px-8 pt-8">
        <div class="bg-white p-6 rounded-lg border-2 border-green-500">
            <!-- Filter Buttons Row -->
            <div class="flex gap-4 mb-6 flex-wrap">
                <button id="allRecordsBtn" 
                        class="px-6 py-2 rounded-md border-2 border-green-500 text-gray-700 bg-white hover:bg-green-50 transition-all duration-200 text-sm font-medium">
                    All Records
                </button>
                <button id="activeRecordsBtn" 
                        class="px-6 py-2 rounded-md border-2 border-green-500 text-gray-700 bg-white hover:bg-green-50 transition-all duration-200 text-sm font-medium">
                    Active
                </button>
                <button id="expiringSoonRecordsBtn" 
                        class="px-6 py-2 rounded-md border-2 border-green-500 text-gray-700 bg-white hover:bg-green-50 transition-all duration-200 text-sm font-medium">
                    To expire
                </button>
                <button id="expiredRecordsBtn" 
                        class="px-6 py-2 rounded-md border-2 border-green-500 text-gray-700 bg-white hover:bg-green-50 transition-all duration-200 text-sm font-medium">
                    Expired
                </button>
            </div>
            
            <!-- Search and filters row -->
            <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                <!-- Search Record -->
                <div class="md:col-span-1">
                    <label class="block text-gray-700 text-sm mb-2">Search Record</label>
                    <div class="relative">
                        <input type="text" id="recordSearch" placeholder="Search record..." 
                               class="w-full px-4 py-2 rounded-md border-2 border-green-500 text-gray-700 focus:outline-none hover:bg-green-50 transition-all duration-200">
                    </div>
                </div>
                
                <!-- Start Date -->
                <div class="md:col-span-1">
                    <label class="block text-gray-700 text-sm mb-2">Start Date</label>
                    <div class="relative">
                        <input type="date" id="startDate" 
                               class="w-full px-4 py-2 rounded-md border-2 border-green-500 text-gray-700 focus:outline-none hover:bg-green-50 transition-all duration-200">
                    </div>
                </div>
                
                <!-- End Date -->
                <div class="md:col-span-1">
                    <label class="block text-gray-700 text-sm mb-2">End Date</label>
                    <div class="relative">
                        <input type="date" id="endDate" 
                               class="w-full px-4 py-2 rounded-md border-2 border-green-500 text-gray-700 focus:outline-none hover:bg-green-50 transition-all duration-200">
                    </div>
                </div>
                
                <!-- Year Filter -->
                <div class="md:col-span-1">
                    <label class="block text-gray-700 text-sm mb-2">Filter by Year</label>
                    <select id="yearFilter" 
                            class="w-full px-4 py-2 rounded-md border-2 border-green-500 text-gray-700 focus:outline-none hover:bg-green-50 transition-all duration-200">
                        <option value="">All Years</option>
                    </select>
                </div>
                
                <!-- Export Button -->
                <div class="md:col-span-1 flex flex-col justify-end">
                    <button onclick="exportTableToCSV('lumber_records.csv')" 
                            class="w-full px-4 py-2 rounded-md border-2 border-green-500 bg-white text-gray-700 hover:bg-green-50 transition-all duration-200 flex items-center justify-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                        </svg>
                        Export
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Records Section -->
    <div class="w-full py-4">
        <div class="bg-white shadow-2xl">
            <div class="overflow-x-auto">
                <div class="inline-block min-w-full">
                    <div class="overflow-hidden">
                        <div class="max-h-[600px] overflow-y-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50 sticky top-0 z-10">
                                    <tr>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider whitespace-nowrap">TRADE NAME</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider whitespace-nowrap">MANAGER/OWNER</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider whitespace-nowrap">LOCATION</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider whitespace-nowrap">PERMIT NO.</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider whitespace-nowrap">ACTIONS</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200">
                                    {% if lumber_records %}
                                        {% for record in lumber_records %}
                                        <tr class="hover:bg-gray-50 transition-colors duration-150 {% if record.is_expired %}bg-red-50{% endif %}" 
                                            data-record-id="{{ record.id }}"
                                            data-issue-date="{{ record.date_issued|date:'Y-m-d' }}"
                                            data-expiry-date="{{ record.expiry_date|date:'Y-m-d' }}">
                                            <td class="px-6 py-3 text-xs text-gray-900 whitespace-nowrap">{{ record.trade_name }}</td>
                                            <td class="px-6 py-3 text-xs text-gray-900 whitespace-nowrap">{{ record.manager_owner }}</td>
                                            <td class="px-6 py-3 text-xs text-gray-900 whitespace-nowrap">{{ record.brgy }}, {{ record.municipality }}, {{ record.province }}</td>
                                            <td class="px-6 py-3 text-xs text-gray-900 whitespace-nowrap">{{ record.permit_no }}</td>
                                            <td class="px-6 py-3 text-xs text-gray-900 whitespace-nowrap">
                                                <div class="flex justify-center space-x-4">
                                                    <a href="{% url 'view_lumber_details' record.id %}" class="text-blue-600 hover:text-blue-800 font-medium flex items-center gap-2">
                                                        
                                                        View
                                                    </a>
                                                    <a href="{% url 'edit_recordlumber' record.id %}" class="text-orange-500 hover:text-orange-700 font-medium">
                                                        Edit
                                                    </a>
                                                </div>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    {% else %}
                                        <tr>
                                            <td colspan="5" class="px-6 py-8 text-center text-gray-500">
                                                No lumber records found. Please add a new record using the lumber form.
                                            </td>
                                        </tr>
                                    {% endif %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="noResultsMessage" class="hidden bg-white rounded-lg shadow-lg my-4">
        <!-- Message will be inserted here by JavaScript -->
    </div>
</div>

<footer class="bg-blue-900 text-white mt-auto py-8">
    <div class="max-w-7xl mx-auto text-center">
        <p class="text-sm">&copy; 2025 Department of Environment and Natural Resources. All rights reserved.</p>
        <p class="text-sm mt-1">CENRO ARGAO | Argao, Cebu</p>
    </div>
</footer>

<script>
    // Toggle user menu
    document.addEventListener('DOMContentLoaded', function() {
        const userMenuButton = document.getElementById('user-menu-button');
        const userMenu = document.getElementById('user-menu');
        
        if (userMenuButton && userMenu) {
            userMenuButton.addEventListener('click', function() {
                userMenu.classList.toggle('hidden');
            });
            
            // Close menu when clicking outside
            document.addEventListener('click', function(event) {
                if (!userMenuButton.contains(event.target) && !userMenu.contains(event.target)) {
                    userMenu.classList.add('hidden');
                }
            });
        }
        
        // Mobile menu toggle
        const mobileMenuButton = document.getElementById('mobile-menu-button');
        const mobileMenu = document.getElementById('mobile-menu');
        
        if (mobileMenuButton && mobileMenu) {
            mobileMenuButton.addEventListener('click', function() {
                mobileMenu.style.display = mobileMenu.style.display === 'block' ? 'none' : 'block';
            });
        }

        // Filter buttons functionality
        const allRecordsBtn = document.getElementById('allRecordsBtn');
        const activeRecordsBtn = document.getElementById('activeRecordsBtn');
        const expiredRecordsBtn = document.getElementById('expiredRecordsBtn');
        const expiringSoonRecordsBtn = document.getElementById('expiringSoonRecordsBtn');
        
        if (allRecordsBtn && activeRecordsBtn && expiredRecordsBtn && expiringSoonRecordsBtn) {
            const rows = document.querySelectorAll('tbody tr');
            
            // Helper function to parse date from dd/mm/yyyy format
            function parseDate(dateStr) {
                if (!dateStr) return null;
                
                // Try different date formats
                const formats = [
                    // DD/MM/YYYY
                    str => {
                        const parts = str.split('/');
                        if (parts.length === 3) {
                            return new Date(parts[2], parts[1] - 1, parts[0]);
                        }
                        return null;
                    },
                    // MM/DD/YYYY
                    str => {
                        const parts = str.split('/');
                        if (parts.length === 3) {
                            return new Date(parts[2], parts[0] - 1, parts[1]);
                        }
                        return null;
                    },
                    // YYYY-MM-DD
                    str => {
                        if (str.match(/^\d{4}-\d{2}-\d{2}$/)) {
                            return new Date(str);
                        }
                        return null;
                    }
                ];
                
                for (const format of formats) {
                    const date = format(dateStr);
                    if (date && !isNaN(date.getTime())) {
                        return date;
                    }
                }
                
                return null;
            }
            
            // Function to apply status classes to rows
            function applyStatusClasses() {
                const today = new Date();
                today.setHours(0, 0, 0, 0); // Set to beginning of day
                
                const thirtyDaysFromNow = new Date(today);
                thirtyDaysFromNow.setDate(today.getDate() + 30);
                
                const rows = document.querySelectorAll('tbody tr');
                
                rows.forEach(row => {
                    // Skip if it's the "No records found" row
                    if (row.querySelector('td[colspan="5"]')) {
                        return;
                    }
                    
                    // Remove existing status classes
                    row.classList.remove('active-record', 'expired-record', 'expiring-soon-record');
                    
                    const expiryDateCell = row.querySelector('td:nth-child(5)');
                    if (expiryDateCell) {
                        const expiryDate = parseDate(expiryDateCell.textContent.trim());
                        
                        if (expiryDate) {
                            if (expiryDate < today) {
                                // Expired
                                row.classList.add('expired-record');
                            } else if (expiryDate <= thirtyDaysFromNow) {
                                // Expiring soon (within 30 days)
                                row.classList.add('expiring-soon-record');
                            } else {
                                // Active
                                row.classList.add('active-record');
                            }
                        }
                    }
                });
            }
            
            // Apply status classes on page load
            applyStatusClasses();
            
            // Show all records
            allRecordsBtn.addEventListener('click', function() {
                rows.forEach(row => {
                    row.style.display = '';
                });
                
                // Update active button styling
                [allRecordsBtn, activeRecordsBtn, expiredRecordsBtn, expiringSoonRecordsBtn].forEach(btn => {
                    btn.classList.remove('ring-2', 'ring-white');
                });
                allRecordsBtn.classList.add('ring-2', 'ring-white');
            });
            
            // Show only active records (not expired or expiring soon)
            activeRecordsBtn.addEventListener('click', function() {
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                const thirtyDaysFromNow = new Date(today);
                thirtyDaysFromNow.setDate(today.getDate() + 30);
                
                rows.forEach(row => {
                    // Skip if it's the "No records found" row
                    if (row.querySelector('td[colspan="5"]')) {
                        return;
                    }
                    
                    const expiryDateCell = row.querySelector('td:nth-child(5)');
                    if (expiryDateCell) {
                        const expiryDate = parseDate(expiryDateCell.textContent.trim());
                        if (expiryDate && expiryDate > thirtyDaysFromNow) {
                            row.style.display = '';
                        } else {
                            row.style.display = 'none';
                        }
                    }
                });
                
                // Update active button styling
                [allRecordsBtn, activeRecordsBtn, expiredRecordsBtn, expiringSoonRecordsBtn].forEach(btn => {
                    btn.classList.remove('ring-2', 'ring-white');
                });
                activeRecordsBtn.classList.add('ring-2', 'ring-white');
            });
            
            // Show only expired records
            expiredRecordsBtn.addEventListener('click', function() {
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                rows.forEach(row => {
                    // Skip if it's the "No records found" row
                    if (row.querySelector('td[colspan="5"]')) {
                        return;
                    }
                    
                    const expiryDateCell = row.querySelector('td:nth-child(5)');
                    if (expiryDateCell) {
                        const expiryDate = parseDate(expiryDateCell.textContent.trim());
                        if (expiryDate && expiryDate < today) {
                            row.style.display = '';
                        } else {
                            row.style.display = 'none';
                        }
                    }
                });
                
                // Update active button styling
                [allRecordsBtn, activeRecordsBtn, expiredRecordsBtn, expiringSoonRecordsBtn].forEach(btn => {
                    btn.classList.remove('ring-2', 'ring-white');
                });
                expiredRecordsBtn.classList.add('ring-2', 'ring-white');
            });
            
            // Show records expiring soon (within 30 days)
            expiringSoonRecordsBtn.addEventListener('click', function() {
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                const thirtyDaysFromNow = new Date(today);
                thirtyDaysFromNow.setDate(today.getDate() + 30);
                
                rows.forEach(row => {
                    // Skip if it's the "No records found" row
                    if (row.querySelector('td[colspan="5"]')) {
                        return;
                    }
                    
                    const expiryDateCell = row.querySelector('td:nth-child(5)');
                    if (expiryDateCell) {
                        const expiryDate = parseDate(expiryDateCell.textContent.trim());
                        if (expiryDate && expiryDate >= today && expiryDate <= thirtyDaysFromNow) {
                            row.style.display = '';
                        } else {
                            row.style.display = 'none';
                        }
                    }
                });
                
                // Update active button styling
                [allRecordsBtn, activeRecordsBtn, expiredRecordsBtn, expiringSoonRecordsBtn].forEach(btn => {
                    btn.classList.remove('ring-2', 'ring-white');
                });
                expiringSoonRecordsBtn.classList.add('ring-2', 'ring-white');
            });
            
            // Set "All Records" as active by default
            allRecordsBtn.classList.add('ring-2', 'ring-white');
        }
        
        // Get the search input element
        const searchInput = document.getElementById('recordSearch');
        
        // Add event listener for search input
        if (searchInput) {
            searchInput.addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase().trim();
                const rows = document.querySelectorAll('tbody tr');
                
                rows.forEach(row => {
                    // Skip if it's the "No records found" row
                    if (row.querySelector('td[colspan="5"]')) {
                        return;
                    }
                    
                    // Get all cell text in the row
                    const rowText = Array.from(row.querySelectorAll('td'))
                        .map(cell => cell.textContent.toLowerCase())
                        .join(' ');
                    
                    // Show/hide row based on search term
                    if (searchTerm === '' || rowText.includes(searchTerm)) {
                        row.style.display = '';
                    } else {
                        row.style.display = 'none';
                    }
                });
            });
        }
        
        // Date range filtering
        const startDateInput = document.getElementById('startDate');
        const endDateInput = document.getElementById('endDate');
        
        if (startDateInput && endDateInput) {
            console.log('Date inputs found:', startDateInput, endDateInput);
            
            function filterByDateRange() {
                const startDateValue = startDateInput.value;
                const endDateValue = endDateInput.value;
                
                console.log('Filtering by date range:', startDateValue, 'to', endDateValue);
                
                if (!startDateValue && !endDateValue) {
                    console.log('No dates selected, showing all records');
                    const rows = document.querySelectorAll('tbody tr');
                    rows.forEach(row => {
                        if (row.querySelector('td[colspan="5"]')) {
                            return;
                        }
                        row.style.display = '';
                    });
                    return;
                }
                
                const startDate = startDateValue ? new Date(startDateValue) : null;
                const endDate = endDateValue ? new Date(endDateValue) : null;
                
                if (startDate) startDate.setHours(0, 0, 0, 0);
                const endOfDay = endDate ? new Date(endDate) : null;
                if (endOfDay) endOfDay.setHours(23, 59, 59, 999);
                
                const rows = document.querySelectorAll('tbody tr');
                let matchCount = 0;
                let noResultsRow = document.querySelector('tr.no-results');
                
                rows.forEach((row, index) => {
                    if (row.querySelector('td[colspan="5"]') || row.classList.contains('no-results')) {
                        return;
                    }
                    
                    const dateIssued = new Date(row.dataset.issueDate);
                    
                    if (dateIssued) {
                        let showRow = true;
                        
                        // Check if the issued date falls within the date range
                        if (startDate && endDate) {
                            showRow = dateIssued >= startDate && dateIssued <= endDate;
                        } else if (startDate) {
                            showRow = dateIssued >= startDate;
                        } else if (endDate) {
                            showRow = dateIssued <= endDate;
                        }
                        
                        row.style.display = showRow ? '' : 'none';
                        
                        if (showRow) {
                            matchCount++;
                        }
                    } else {
                        row.style.display = '';
                    }
                });
                
                // Update no results message
                if (matchCount === 0) {
                    if (!noResultsRow) {
                        const tbody = document.querySelector('tbody');
                        noResultsRow = document.createElement('tr');
                        noResultsRow.classList.add('no-results');
                        noResultsRow.innerHTML = `
                            <td colspan="5" class="px-6 py-8 text-center">
                                <div class="text-gray-500 text-lg">No matching records found</div>
                                <div class="text-gray-400 text-sm mt-2">Try adjusting your filter criteria</div>
                            </td>
                        `;
                        tbody.appendChild(noResultsRow);
                    } else {
                        noResultsRow.style.display = '';
                    }
                } else if (noResultsRow) {
                    noResultsRow.style.display = 'none';
                }
            }
            
            // Add event listener for start date to automatically set end date range
            startDateInput.addEventListener('change', function() {
                const startDate = new Date(this.value);
                if (startDate) {
                    // Set end date to 9 months after start date
                    const endDate = new Date(startDate);
                    endDate.setMonth(endDate.getMonth() + 9);
                    
                    // Format the date as YYYY-MM-DD
                    const formattedDate = endDate.toISOString().split('T')[0];
                    endDateInput.value = formattedDate;
                    
                    // Trigger the filter
                    filterByDateRange();
                }
            });
            
            // Handle end date change
            endDateInput.addEventListener('input', function() {
                console.log('End date input changed:', this.value);
                filterByDateRange();
            });
            
            endDateInput.addEventListener('change', function() {
                console.log('End date changed:', this.value);
                filterByDateRange();
            });
        } else {
            console.warn('Date inputs not found!');
        }
        
        // Fix file display issue - ensure file links are working
        const fileLinks = document.querySelectorAll('a[href$=".pdf"], a[href$=".jpg"], a[href$=".png"], a[href$=".docx"]');
        fileLinks.forEach(link => {
            link.addEventListener('click', function(e) {
                // Prevent default only if the link is empty or "#"
                if (!this.getAttribute('href') || this.getAttribute('href') === '#') {
                    e.preventDefault();
                    alert('File not available or still processing. Please try again later.');
                }
            });
        });

        // Re-apply status classes after any filtering
        const filterInputs = document.querySelectorAll('input[type="text"], input[type="date"]');
        filterInputs.forEach(input => {
            input.addEventListener('input', function() {
                // Wait a bit for the filtering to complete
                setTimeout(applyStatusClasses, 100);
            });
            
            input.addEventListener('change', function() {
                // Wait a bit for the filtering to complete
                setTimeout(applyStatusClasses, 100);
            });
        });

        // Function to filter records by year
        function filterByYear(year) {
            if (!year) {
                // If no year selected, show all records
                const rows = document.querySelectorAll('tbody tr');
                rows.forEach(row => {
                    // Skip if it's the "No records found" row
                    if (row.querySelector('td[colspan="5"]')) {
                        return;
                    }
                    row.style.display = '';
                });
                return;
            }
            
            const rows = document.querySelectorAll('tbody tr');
            let matchCount = 0;
            
            rows.forEach(row => {
                // Skip if it's the "No records found" row
                if (row.querySelector('td[colspan="5"]')) {
                    return;
                }
                
                // Use the data-issue-date attribute instead of looking at cells
                const dateIssued = new Date(row.dataset.issueDate);
                
                if (dateIssued && dateIssued.getFullYear().toString() === year) {
                    row.style.display = '';
                    matchCount++;
                } else {
                    row.style.display = 'none';
                }
            });

            // Show "No results" message if no matches found
            const noResultsMessage = document.getElementById('noResultsMessage');
            if (noResultsMessage) {
                if (matchCount === 0) {
                    noResultsMessage.classList.remove('hidden');
                    noResultsMessage.innerHTML = `
                        <div class="p-4 text-center">
                            <div class="text-gray-500 text-lg">No records found for year ${year}</div>
                            <div class="text-gray-400 text-sm mt-2">Try selecting a different year</div>
                        </div>
                    `;
                } else {
                    noResultsMessage.classList.add('hidden');
                }
            }
        }

        // Populate year dropdown with years from 2010 to 2025
        document.addEventListener('DOMContentLoaded', function() {
            const yearFilter = document.getElementById('yearFilter');
            if (yearFilter) {
                const endYear = 2025;
                const startYear = 2010;
                
                // Add "All Years" option
                const allYearsOption = document.createElement('option');
                allYearsOption.value = '';
                allYearsOption.textContent = 'All Years';
                yearFilter.appendChild(allYearsOption);
                
                // Add years from 2025 down to 2010
                for (let year = endYear; year >= startYear; year--) {
                    const option = document.createElement('option');
                    option.value = year.toString();
                    option.textContent = year.toString();
                    yearFilter.appendChild(option);
                }
                
                // Add event listener for year filter change
                yearFilter.addEventListener('change', function() {
                    console.log('Year filter changed to:', this.value);
                    filterByYear(this.value);
                });
            }
        });

        // Add context menu element to the body
        const contextMenu = document.createElement('div');
        contextMenu.className = 'context-menu hidden';
        contextMenu.innerHTML = `
            <div class="context-menu-item" id="view-option">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                </svg>
                View
            </div>
            <div class="context-menu-item" id="edit-option">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                </svg>
                Edit
            </div>
        `;
        document.body.appendChild(contextMenu);

        // Handle double click on table rows
        const tableRows = document.querySelectorAll('tbody tr');
        console.log('Found rows:', tableRows.length); // Debug log

        tableRows.forEach(row => {
            row.addEventListener('dblclick', function(e) {
                if (row.querySelector('td[colspan]')) return;

                e.preventDefault();
                
                const recordId = this.dataset.recordId || 
                               this.querySelector('a[href*="/view/"]')?.href?.match(/\d+/)?.[0] ||
                               this.querySelector('a[href*="/edit/"]')?.href?.match(/\d+/)?.[0];
                
                if (!recordId) return;

                // Position menu directly at cursor position with a slight offset to the right
                contextMenu.style.position = 'fixed';
                contextMenu.style.left = `${e.clientX + 15}px`;  // 15px to the right of cursor
                contextMenu.style.top = `${e.clientY}px`;       // Same Y position as cursor
                contextMenu.classList.remove('hidden');

                const viewOption = document.getElementById('view-option');
                const editOption = document.getElementById('edit-option');

                viewOption.onclick = () => window.location.href = `/lumber/${recordId}/details/`;
                editOption.onclick = () => window.location.href = `/edit_recordlumber/${recordId}/`;
            });
        });

        // Hide context menu when clicking outside
        document.addEventListener('click', function(e) {
            if (!contextMenu.contains(e.target)) {
                contextMenu.classList.add('hidden');
            }
        });
    });
    
    // CSV Export Function - Only exports visible (filtered) rows
    function exportTableToCSV(filename) {
        const csv = [];
        const rows = document.querySelectorAll('table tr');
        
        // Get all visible rows (header + filtered data rows)
        const visibleRows = Array.from(rows).filter(row => {
            // Always include header row
            if (row.parentElement.tagName === 'THEAD') {
                return true;
            }
            // Only include visible body rows and exclude "no results" row
            return row.style.display !== 'none' && !row.classList.contains('no-results');
        });
        
        console.log(`Exporting ${visibleRows.length} rows (including header)`);
        
        visibleRows.forEach(row => {
            const rowData = [];
            const cols = row.querySelectorAll('td, th');
            
            cols.forEach(col => {
                // Replace any commas in the cell text to avoid CSV issues
                let text = col.innerText.replace(/,/g, ';');
                // Remove any quotes to avoid CSV issues
                text = text.replace(/"/g, '');
                // Wrap in quotes to handle any remaining special characters
                rowData.push('"' + text + '"');
            });
            
            csv.push(rowData.join(','));
        });
        
        // Download CSV file
        downloadCSV(csv.join('\n'), filename);
        console.log('Export complete');
    }
    
    function downloadCSV(csv, filename) {
        const csvFile = new Blob([csv], {type: 'text/csv'});
        const downloadLink = document.createElement('a');
        
        // Create a link to download the CSV file
        downloadLink.download = filename;
        downloadLink.href = window.URL.createObjectURL(csvFile);
        downloadLink.style.display = 'none';
        
        // Trigger download
        document.body.appendChild(downloadLink);
        downloadLink.click();
        document.body.removeChild(downloadLink);
    }

    document.addEventListener('DOMContentLoaded', function() {
        // Get button elements
        const allRecordsBtn = document.getElementById('allRecordsBtn');
        const activeRecordsBtn = document.getElementById('activeRecordsBtn');
        const expiringSoonRecordsBtn = document.getElementById('expiringSoonRecordsBtn');
        const expiredRecordsBtn = document.getElementById('expiredRecordsBtn');

        // Helper function to check if a date is expired
        function isExpired(row) {
            const expiryDate = new Date(row.dataset.expiryDate);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            return expiryDate < today;
        }

        // Update the isExpiringSoon function to check if within last 3 months before expiry
        function isExpiringSoon(row) {
            const expiryDate = new Date(row.dataset.expiryDate);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            // Calculate date 3 months before expiry
            const threeMonthsBeforeExpiry = new Date(expiryDate);
            threeMonthsBeforeExpiry.setMonth(expiryDate.getMonth() - 3);
            
            // Record is "expiring soon" if today is after (or equal to) 3 months before expiry
            // but before the actual expiry date
            return today >= threeMonthsBeforeExpiry && today < expiryDate;
        }

        // Function to filter records based on status
        function filterByStatus(status) {
            const rows = document.querySelectorAll('tbody tr');
            
            rows.forEach(row => {
                // Skip the "no records" row if it exists
                if (row.querySelector('td[colspan="5"]')) return;

                // Get the permit number which contains the date
                const permitCell = row.querySelector('td:nth-child(4)');
                if (!permitCell) return;

                const permitNo = permitCell.textContent;
                // Extract date from permit number (assuming format includes date)
                const dateMatch = permitNo.match(/\d{2,4}$/);
                if (!dateMatch) return;

                const permitDate = new Date(dateMatch[0]);
                
                switch(status) {
                    case 'all':
                        row.style.display = '';
                        break;
                    case 'active':
                        row.style.display = !isExpired(row) && !isExpiringSoon(row) ? '' : 'none';
                        break;
                    case 'expiring':
                        row.style.display = isExpiringSoon(row) ? '' : 'none';
                        break;
                    case 'expired':
                        row.style.display = isExpired(row) ? '' : 'none';
                        break;
                }
            });

            // Update active button state
            [allRecordsBtn, activeRecordsBtn, expiringSoonRecordsBtn, expiredRecordsBtn].forEach(btn => {
                btn.classList.remove('bg-green-500', 'text-white');
                btn.classList.add('bg-white', 'text-gray-700');
            });

            // Highlight active button
            switch(status) {
                case 'all':
                    allRecordsBtn.classList.remove('bg-white', 'text-gray-700');
                    allRecordsBtn.classList.add('bg-green-500', 'text-white');
                    break;
                case 'active':
                    activeRecordsBtn.classList.remove('bg-white', 'text-gray-700');
                    activeRecordsBtn.classList.add('bg-green-500', 'text-white');
                    break;
                case 'expiring':
                    expiringSoonRecordsBtn.classList.remove('bg-white', 'text-gray-700');
                    expiringSoonRecordsBtn.classList.add('bg-green-500', 'text-white');
                    break;
                case 'expired':
                    expiredRecordsBtn.classList.remove('bg-white', 'text-gray-700');
                    expiredRecordsBtn.classList.add('bg-green-500', 'text-white');
                    break;
            }
        }

        // Add click event listeners to buttons
        allRecordsBtn.addEventListener('click', () => filterByStatus('all'));
        activeRecordsBtn.addEventListener('click', () => filterByStatus('active'));
        expiringSoonRecordsBtn.addEventListener('click', () => filterByStatus('expiring'));
        expiredRecordsBtn.addEventListener('click', () => filterByStatus('expired'));

        // Set "All Records" as default active button
        filterByStatus('all');
    });

    // Update the notification JavaScript
    document.addEventListener('DOMContentLoaded', function() {
        const notificationButton = document.getElementById('notification-button');
        const notificationDropdown = document.getElementById('notification-dropdown');
        const notificationBadge = document.getElementById('notification-badge');
        const notificationList = document.getElementById('notification-list');
        
        // Store dismissed notifications
        let dismissedNotifications = new Set();

        // Function to check for expiring records
        function checkExpiringRecords() {
            const rows = document.querySelectorAll('tbody tr');
            const expiringRecords = [];
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            rows.forEach(row => {
                if (row.querySelector('td[colspan="5"]')) return;

                const expiryDate = new Date(row.dataset.expiryDate);
                const threeMonthsBeforeExpiry = new Date(expiryDate);
                threeMonthsBeforeExpiry.setMonth(expiryDate.getMonth() - 3);

                // Only add if not dismissed
                const notificationId = `${row.dataset.expiryDate}-${row.querySelector('td:nth-child(4)').textContent}`;
                if (today >= threeMonthsBeforeExpiry && today < expiryDate && !dismissedNotifications.has(notificationId)) {
                    const tradeName = row.querySelector('td:nth-child(1)').textContent;
                    const permitNo = row.querySelector('td:nth-child(4)').textContent;
                    const daysUntilExpiry = Math.ceil((expiryDate - today) / (1000 * 60 * 60 * 24));

                    expiringRecords.push({
                        id: notificationId,
                        tradeName,
                        permitNo,
                        expiryDate,
                        daysUntilExpiry
                    });
                }
            });

            // Update notification badge
            if (expiringRecords.length > 0) {
                notificationBadge.textContent = expiringRecords.length;
                notificationBadge.classList.remove('hidden');
            } else {
                notificationBadge.classList.add('hidden');
            }

            // Update notification list
            notificationList.innerHTML = expiringRecords.length > 0 
                ? expiringRecords.map(record => `
                    <div class="p-3 bg-yellow-50 rounded-lg border border-yellow-100 relative" data-notification-id="${record.id}">
                        <button class="absolute top-2 right-2 text-gray-400 hover:text-gray-600 focus:outline-none close-notification">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                        <div class="font-semibold text-gray-900 pr-6">${record.tradeName}</div>
                        <div class="text-sm text-gray-600">Permit No: ${record.permitNo}</div>
                        <div class="text-sm text-red-600 mt-1">
                            Expires in ${record.daysUntilExpiry} days
                            (${record.expiryDate.toLocaleDateString()})
                        </div>
                    </div>
                `).join('')
                : '<div class="text-gray-500 text-center py-4">No records expiring soon</div>';

            // Add event listeners to close buttons
            document.querySelectorAll('.close-notification').forEach(button => {
                button.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const notification = this.closest('[data-notification-id]');
                    const notificationId = notification.dataset.notificationId;
                    
                    // Add to dismissed set
                    dismissedNotifications.add(notificationId);
                    
                    // Remove the notification
                    notification.remove();
                    
                    // Update badge count
                    const remainingNotifications = notificationList.querySelectorAll('[data-notification-id]').length;
                    if (remainingNotifications > 0) {
                        notificationBadge.textContent = remainingNotifications;
                    } else {
                        notificationBadge.classList.add('hidden');
                        notificationList.innerHTML = '<div class="text-gray-500 text-center py-4">No records expiring soon</div>';
                    }
                });
            });
        }

        // Toggle notification dropdown
        notificationButton.addEventListener('click', function(e) {
            e.stopPropagation();
            notificationDropdown.classList.toggle('hidden');
        });

        // Close dropdown when clicking outside
        document.addEventListener('click', function(e) {
            if (!notificationDropdown.contains(e.target) && !notificationButton.contains(e.target)) {
                notificationDropdown.classList.add('hidden');
            }
        });

        // Initial check for expiring records
        checkExpiringRecords();

        // Check for expiring records periodically (every 5 minutes)
        setInterval(checkExpiringRecords, 5 * 60 * 1000);
    });
</script>

</body>
</html>
