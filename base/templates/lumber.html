{% load static %}
{% load form_filters %}  <!-- Load custom filters -->
{% load widget_tweaks %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CENRO Argao - Lumber Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <!-- Add SweetAlert2 CDN -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body {
            background-color: #f0fdf4; /* Light green background */
        }
        .modal-open {
            overflow: hidden;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        #notificationModal {
            animation: fadeIn 0.3s ease-out;
        }

        /* Add smooth transition for validation info */
        .validation-info {
            transition: all 0.3s ease-in-out;
            opacity: 0;
            transform: translateY(-10px);
        }

        .validation-info:not(.hidden) {
            opacity: 1;
            transform: translateY(0);
        }

        /* Make form labels more readable */
        .form-group label {
            font-size: 1rem;
            margin-bottom: 0.5rem;
            display: block;
        }

        /* Style form inputs */
        .form-group input,
        .form-group select,
        .form-group textarea {
            font-size: 1rem;
            padding: 0.5rem;
            width: 100%;
            border-radius: 0.375rem;
            border: 1px solid #D1D5DB;
        }

        /* Hover effect for inputs */
        .form-group input:hover,
        .form-group select:hover,
        .form-group textarea:hover {
            border-color: #9CA3AF;
        }

        /* Focus effect for inputs */
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #2563EB;
            ring: 2px;
            ring-color: #93C5FD;
        }

        .form-input {
            @apply mt-1 block w-full rounded-md border-gray-300 shadow-sm 
                   focus:border-blue-500 focus:ring-blue-500 
                   bg-gray-50 text-gray-900; /* Updated to match theme */
            padding: 0.5rem;
            transition: all 0.2s;
        }

        .form-input:hover {
            @apply border-blue-400;
        }

        .form-input:focus {
            @apply ring-2 ring-blue-200;
        }

        .form-input:invalid {
            @apply border-red-300;
        }

        .form-input:invalid:focus {
            @apply ring-red-200;
        }

        /* Custom styling for date inputs */
        input[type="date"].form-input {
            @apply p-2;
        }

        /* Custom styling for select inputs */
        select.form-input {
            @apply pr-8;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }

        /* Error message styling */
        .error-message {
            @apply text-red-500 text-sm mt-1;
            display: none;
        }

        /* Required field indicator */
        label:after {
            content: " *";
            @apply text-red-500;
        }

        input, select, textarea {
            background-color: #f8fafc; /* Light gray background */
            border: 1px solid #e2e8f0;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
            padding: 0.5rem;
            border-radius: 0.375rem;
            width: 100%;
            color: #4B5563; /* Dark gray text */
        }
        input::placeholder, select::placeholder, textarea::placeholder {
            color: #6B7280;
            opacity: 0.8;
        }
        input:focus, select:focus, textarea:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
            outline: none;
        }
        .form-input {
            @apply mt-1 block w-full rounded-md border-gray-300 shadow-sm 
                   focus:border-blue-500 focus:ring-blue-500 
                   bg-gray-50 text-gray-900;
        }
        input[type="date"] {
            padding: 0.4rem;
            color: #4B5563;
        }
        select {
            background-color: #f8fafc;
            padding: 0.4rem;
            color: #4B5563;
        }
        input:hover, select:hover, textarea:hover {
            border-color: #60A5FA;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        /* Add specific styling for date inputs to show the placeholder */
        input[type="date"]::before {
            content: attr(placeholder);
            position: absolute;
            color: #6B7280;
        }

        input[type="date"]:focus::before,
        input[type="date"]:valid::before {
            display: none;
        }

        /* Style file input */
        input[type="file"] {
            padding: 0.375rem;
        }
        input[type="file"]::-webkit-file-upload-button {
            padding: 0.5rem 1rem;
            margin-right: 1rem;
            background-color: #E5E7EB;
            border: none;
            border-radius: 0.375rem;
            color: #374151;
            cursor: pointer;
        }
        input[type="file"]::-webkit-file-upload-button:hover {
            background-color: #D1D5DB;
        }

        /* Remove the previous date input styles and add these new ones */
        .date-input {
            position: relative;
            background-color: #f8fafc;
        }

        .date-input::-webkit-calendar-picker-indicator {
            background: transparent;
            bottom: 0;
            color: transparent;
            cursor: pointer;
            height: auto;
            left: 0;
            position: absolute;
            right: 0;
            top: 0;
            width: auto;
        }

        /* Remove the previous ::before pseudo-element styles for date inputs */
        input[type="date"]::before {
            content: none;
        }

        /* Add these styles to your existing style section */
        .validation-message {
            opacity: 0;
            transform: translateY(-10px);
            transition: all 0.3s ease-in-out;
        }

        .validation-message.show {
            opacity: 1;
            transform: translateY(0);
        }

        .no-results-message {
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Add visual feedback for updates */
        .updated {
            animation: highlight 0.3s ease-out;
        }
        
        @keyframes highlight {
            0% { background-color: #fff; }
            50% { background-color: #e3f2fd; }
            100% { background-color: #fff; }
        }

        /* Style for readonly net volume field */
        #netVolume {
            background-color: #f8fafc;
            color: #4B5563;
            cursor: default;
        }

        input[type="number"] {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            outline: none;
        }

        input[type="number"]:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        input[readonly] {
            background-color: #f8f9fa;
            cursor: not-allowed;
        }

        /* Situation dropdown styling */
        select[name="situation"] {
            @apply bg-white border border-gray-300 rounded-md shadow-sm;
            padding: 0.5rem;
            width: 100%;
        }

        select[name="situation"]:focus {
            @apply ring-2 ring-blue-500 border-blue-500;
            outline: none;
        }

        /* Style for the options */
        select[name="situation"] option[value="Good"] {
            color: #059669;
        }

        select[name="situation"] option[value="Pending"] {
            color: #d97706;
        }

        .bg-blue-600 {
            background-color: #3b82f6; /* Updated to match theme */
        }
        .bg-blue-700 {
            background-color: #2563eb; /* Updated to match theme */
        }
        .bg-white {
            background-color: #ffffff; /* White background for forms */
        }
        .text-gray-700 {
            color: #4B5563; /* Dark gray text */
        }

        /* Add validation styles */
        .error-message {
            @apply text-red-500 text-sm mt-1;
            display: none;
        }

        .invalid-input {
            @apply border-red-500 !important;
        }

        .valid-input {
            @apply border-green-500 !important;
        }
    </style>
</head>
<body class="font-inter text-gray-900">
    <!-- Navigation Bar -->
    <nav class="bg-transparent shadow-lg border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center">
                    <!-- Logo -->
                    <div class="flex-shrink-0">
                        <span class="text-xl font-bold text-green-700">FUS-CENRO-ARGAO</span>
                    </div>
                </div>
                <!-- User Menu -->
                <div class="hidden md:flex items-center space-x-4">
                    <div class="text-lg text-gray-900 font-medium">
                        Welcome, {{ request.user.username }}
                    </div>
                    <div class="relative">
                        <button type="button" class="text-lg text-blue-600 hover:text-blue-800 transition duration-200 focus:outline-none" id="user-menu-button" aria-expanded="false" aria-haspopup="true">
                            ▼
                        </button>
                        <div class="absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg z-20 hidden" id="user-menu">
                            <div class="py-1" role="menu" aria-orientation="vertical" aria-labelledby="user-menu-button">
                                <!-- Quick Actions -->
                                <div class="px-4 py-2 text-sm text-black-800">Quick Actions</div>
                                <div class="grid grid-cols-1 gap-2">
                                    <a href="{% url 'dashboard' %}" class="block px-4 py-2 text-sm text-green-700 hover:bg-gray-100">Dashboard</a>
                                    <a href="{% url 'cutting' %}" class="block px-4 py-2 text-sm text-green-700 hover:bg-gray-100">Cutting Permits</a>
                                    <a href="{% url 'lumber' %}" class="block px-4 py-2 text-sm text-green-700 hover:bg-gray-100">Lumber</a>
                                    <a href="{% url 'chainsaw' %}" class="block px-4 py-2 text-sm text-green-700 hover:bg-gray-100">Chainsaw</a>
                                    <a href="{% url 'wood' %}" class="block px-4 py-2 text-sm text-green-700 hover:bg-gray-100">WPP</a>
                                </div>
                                <a href="{% url 'logout' %}" class="block px-4 py-2 text-sm text-black-900 hover:bg-gray-100" role="menuitem">
                                    <svg class="inline w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 12H8m8 0l-4-4m4 4l-4 4"></path>
                                    </svg>
                                    Sign Out
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Mobile Menu Button -->
                <div class="md:hidden">
                    <button class="text-gray-500 hover:text-gray-700 focus:outline-none" id="mobile-menu-button">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
        <!-- Mobile Menu -->
        <div class="md:hidden" id="mobile-menu" style="display: none;">
            <div class="px-2 pt-2 pb-3 space-y-1">
                <a href="{% url 'logout' %}" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Sign Out</a>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Form Section -->
        <div class="max-w-5xl mx-auto bg-white p-8 mt-8 shadow-xl rounded-lg">
            <h2 class="text-2xl font-bold mb-6">Add New Lumber Record</h2>
            <form method="POST" id="lumberForm" class="space-y-6" enctype="multipart/form-data">
                {% csrf_token %}
                
                <!-- Global Messages -->
                {% if messages %}
                <div class="mb-4">
                    {% for message in messages %}
                    <div class="{% if message.tags == 'success' %}bg-green-100 border-l-4 border-green-500 text-green-700{% else %}bg-red-100 border-l-4 border-red-500 text-red-700{% endif %} p-4 mb-2">
                        {{ message }}
                    </div>
                    {% endfor %}
                </div>
                {% endif %}

                <!-- First Row -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">No.</label>
                        <input type="text" name="no" class="form-input" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Trade Name</label>
                        <input type="text" name="trade_name" class="form-input" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Manager/Owner</label>
                        <input type="text" name="manager_owner" class="form-input" required>
                    </div>
                </div>

                <!-- Second Row -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Contact No.</label>
                        <input type="text" name="contact_number" class="form-input" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Gender</label>
                        <select name="gender" class="form-input" required>
                            <option value="">Select Gender</option>
                            <option value="Male">Male</option>
                            <option value="Female">Female</option>
                        </select>
                    </div>
                </div>

                <!-- Third Row -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Barangay</label>
                        <input type="text" name="brgy" class="form-input" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Municipality</label>
                        <input type="text" name="municipality" class="form-input" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Province</label>
                        <input type="text" name="province" class="form-input" required>
                    </div>
                </div>

                <!-- Fourth Row -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Permit No.</label>
                        <input type="text" name="permit_no" class="form-input" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Date Issued</label>
                        <input type="text" 
                               name="date_issued" 
                               class="form-input date-input"
                               placeholder="dd/mm/yyyy"
                               onfocus="(this.type='date')"
                               onblur="if(!this.value)this.type='text'"
                               required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Expiry Date</label>
                        <input type="text" 
                               name="expiry_date" 
                               class="form-input date-input"
                               placeholder="dd/mm/yyyy"
                               onfocus="(this.type='date')"
                               onblur="if(!this.value)this.type='text'"
                               required>
                    </div>
                </div>

                <!-- Fifth Row -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Source/Supplier</label>
                        <input type="text" name="source_supplier" class="form-input" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Volume (cubic meter) </label>
                        <input type="number" name="volume_cubic_meter" class="form-input" step="0.01" min="0.01" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Species</label>
                        <input type="text" name="species" class="form-input" required>
                    </div>
                </div>

                <!-- File Upload -->
                <div class="mt-6">
                    <label class="block text-sm font-medium text-gray-700">Attach File</label>
                    <input type="file" name="file" id="id_file" class="form-input mt-1 block w-full" accept=".pdf,.doc,.docx,.jpg,.jpeg,.png">
                </div>

                <!-- Submit Button -->
                <div class="flex justify-end gap-4 mt-6">
                    <button type="reset" class="border border-red-300 text-gray-700 px-6 py-2 rounded-lg hover:bg-gray-100 transition duration-200 shadow-md">
                        Clear Form
                    </button>
                    <button type="submit" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition duration-200 shadow-md flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-11a1 1 0 10-2 0v2H7a1 1 0 100 2h2v2a1 1 0 102 0v-2h2a1 1 0 100-2h-2V7z" clip-rule="evenodd" />
                        </svg>
                        Submit
                    </button>
                    <a href="{% url 'lumber_records' %}" class="bg-green-500 text-white px-6 py-2 rounded-lg hover:bg-green-600 transition duration-200 shadow-md flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z" clip-rule="evenodd" />
                        </svg>
                        View Records
                    </a>
                </div>
            </form>
        </div>
    </div>
    <!-- Footer -->
    <footer class="bg-blue-800 text-white w-full py-8">
        <div class="text-center">
            <p class="text-sm">&copy; 2025 Department of Environment and Natural Resources. All rights reserved.</p>
            <p class="text-sm mt-1">CENRO ARGAO | Argao, Cebu</p>
        </div>
    </footer>

    <!-- Modal Backdrop -->
    <div id="notificationModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden overflow-y-auto h-full w-full z-50">
        <!-- Modal Content -->
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-yellow-100">
                    <!-- Warning Icon -->
                    <svg class="h-6 w-6 text-yellow-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                    </svg>
                </div>
                <h3 class="text-lg leading-6 font-medium text-gray-900 mt-4">Expiring Permits Alert</h3>
                <div class="mt-2 px-7 py-3">
                    <div class="text-sm text-gray-500 max-h-60 overflow-y-auto">
                        {% for record in lumber_records %}
                            {% if record.expiry_warning %}
                            <div class="mb-3 p-3 bg-yellow-50 rounded-lg text-left">
                                <p class="text-yellow-700">
                                    <span class="font-semibold">{{ record.trade_name }}</span><br>
                                    Permit No: {{ record.permit_no }}<br>
                                    Expires: {{ record.expiry_date|date:"F d, Y" }}
                                </p>
                            </div>
                            {% endif %}
                        {% endfor %}
                    </div>
                </div>
                <div class="items-center px-4 py-3">
                    <button id="closeModal" class="px-4 py-2 bg-yellow-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-yellow-600 focus:outline-none focus:ring-2 focus:ring-yellow-300">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification Component (replaces the Success Notification) -->
    <div id="notification" class="hidden fixed top-4 right-4 px-6 py-3 rounded shadow-lg transition-opacity duration-300">
        <span id="notificationMessage"></span>
        <button onclick="this.parentElement.classList.add('hidden')" class="ml-2 font-bold">&times;</button>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const modal = document.getElementById('notificationModal');
            const closeButton = document.getElementById('closeModal');
            
            // Check if there are any expiring records and notification hasn't been shown
            const hasExpiringRecords = "{{ any_expiring_records }}" === "True";
            const notificationShown = sessionStorage.getItem('notificationShown');
            
            if (hasExpiringRecords && !notificationShown) {
                // Show modal on page load
                modal.classList.remove('hidden');
                // Store in session that user has seen the notification
                sessionStorage.setItem('notificationShown', 'true');
            }
            
            // Close modal when clicking close button
            closeButton.addEventListener('click', function() {
                modal.classList.add('hidden');
            });
            
            // Close modal when clicking outside
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.classList.add('hidden');
                }
            });
            
            // Close modal with ESC key
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && !modal.classList.contains('hidden')) {
                    modal.classList.add('hidden');
                }
            });
            // Show validation info on input focus
            const formGroups = document.querySelectorAll('.form-group');
            
            formGroups.forEach(group => {
                const input = group.querySelector('input, select, textarea');
                const validationInfo = group.querySelector('.validation-info');
                
                if (input && validationInfo) {
                    input.addEventListener('focus', () => {
                        // Hide all other validation infos first
                        document.querySelectorAll('.validation-info').forEach(info => {
                            info.classList.add('hidden');
                        });
                        // Show this validation info
                        validationInfo.classList.remove('hidden');
                    });
                }
            });

            // Hide validation info when clicking outside
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.form-group')) {
                    document.querySelectorAll('.validation-info').forEach(info => {
                        info.classList.add('hidden');
                    });
                }
            });

            // Get the form element
            let form = document.getElementById('lumberForm');
            
            // Define required fields and their labels
            const requiredFields = [
                { name: 'no', label: 'No.' },
                { name: 'trade_name', label: 'Trade Name' },
                { name: 'manager_owner', label: 'Manager/Owner' },
                { name: 'contact_number', label: 'Contact No.' },
                { name: 'gender', label: 'Gender' },
                { name: 'permit_no', label: 'Permit No.' },
                { name: 'date_issued', label: 'Date Issued' },
                { name: 'expiry_date', label: 'Expiry Date' },
                { name: 'source_supplier', label: 'Source/Supplier' },
                { name: 'volume_cubic_meter', label: 'Volume' },
                { name: 'species', label: 'Species' },
                { name: 'brgy', label: 'Barangay' },
                { name: 'municipality', label: 'Municipality' },
                { name: 'province', label: 'Province' }
            ];

            // Modify the form submission validation for dates
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                
                let hasError = false;
                let firstErrorField = null;
                let errorMessages = [];

                // Check each required field
                requiredFields.forEach(field => {
                    const input = form.querySelector(`[name="${field.name}"]`);
                    
                    // Remove any existing error styling
                    input.classList.remove('border-red-500');

                    // Check if field is empty
                    if (!input.value.trim()) {
                        hasError = true;
                        input.classList.add('border-red-500');
                        errorMessages.push(`${field.label} is required`);
                        
                        if (!firstErrorField) {
                            firstErrorField = input;
                        }
                    }
                });

                // Validate contact number format
                const contactNo = form.querySelector('[name="contact_number"]');
                if (contactNo.value.trim() && !/^09\d{9}$/.test(contactNo.value.trim())) {
                    hasError = true;
                    contactNo.classList.add('border-red-500');
                    errorMessages.push('Contact No. must be a valid Philippine mobile number (11 digits starting with 09)');
                    if (!firstErrorField) firstErrorField = contactNo;
                }

                // Validate date fields - updated to check 3-month rule
                const dateIssued = form.querySelector('[name="date_issued"]');
                const expiryDate = form.querySelector('[name="expiry_date"]');
                
                if (dateIssued.value && expiryDate.value) {
                    const issued = new Date(dateIssued.value);
                    const expiry = new Date(expiryDate.value);
                    
                    // Calculate minimum expiry (issue date)
                    const minExpiry = new Date(issued);
                    
                    // Calculate recommended expiry (3 months from issue date)
                    const recommendedExpiry = new Date(issued);
                    recommendedExpiry.setMonth(recommendedExpiry.getMonth() + 3);
                    
                    if (expiry < minExpiry) {
                        hasError = true;
                        expiryDate.classList.add('border-red-500');
                        errorMessages.push('Expiry date cannot be earlier than date issued');
                        if (!firstErrorField) firstErrorField = expiryDate;
                    }
                    
                    // Check if expiry date is different from recommended 3 months
                    const daysDifference = Math.abs(Math.ceil((expiry - recommendedExpiry) / (1000 * 60 * 60 * 24)));
                    if (daysDifference > 7) { // Allow a week of flexibility
                        // This is just a warning, not an error
                        const warningMessage = 'The expiry date differs from the standard 3-month period. Please confirm this is intentional.';
                        
                        // We'll show this warning after validation if there are no errors
                        if (!hasError) {
                            const confirmSubmit = confirm(warningMessage + "\n\nDo you want to proceed with submission?");
                            if (!confirmSubmit) {
                                e.preventDefault();
                                return;
                            }
                        } else {
                            errorMessages.push(warningMessage);
                        }
                    }
                }

                // Validate volume is positive
                const volume = form.querySelector('[name="volume_cubic_meter"]');
                if (volume.value && parseFloat(volume.value) <= 0) {
                    hasError = true;
                    volume.classList.add('border-red-500');
                    errorMessages.push('Volume must be greater than zero');
                    if (!firstErrorField) firstErrorField = volume;
                }

                // Ensure contact number is not empty
                const contactNoValue = contactNo.value.trim();
                if (!contactNoValue) {
                    hasError = true;
                    contactNo.classList.add('border-red-500');
                    errorMessages.push('Contact No. is required');
                    if (!firstErrorField) firstErrorField = contactNo;
                }

                // If there are errors, show SweetAlert with error messages
                if (hasError) {
                    Swal.fire({
                        title: 'Validation Error',
                        html: `<div class="text-left"><ul class="list-disc pl-5">
                            ${errorMessages.map(msg => `<li>${msg}</li>`).join('')}
                        </ul></div>`,
                        icon: 'error',
                        confirmButtonText: 'OK',
                        confirmButtonColor: '#3085d6'
                    }).then(() => {
                        // Scroll to first error field
                        if (firstErrorField) {
                            firstErrorField.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            firstErrorField.focus();
                        }
                    });
                } else {
                    // Show confirmation dialog
                    Swal.fire({
                        title: 'Confirm Submission',
                        text: 'Are you sure you want to submit this lumber record?',
                        icon: 'question',
                        showCancelButton: true,
                        confirmButtonText: 'Yes, submit it!',
                        cancelButtonText: 'Cancel',
                        confirmButtonColor: '#3085d6',
                        cancelButtonColor: '#d33'
                    }).then((result) => {
                        if (result.isConfirmed) {
                            // Show loading state
                            Swal.fire({
                                title: 'Saving...',
                                html: 'Please wait while we process your submission.',
                                allowOutsideClick: false,
                                didOpen: () => {
                                    Swal.showLoading();
                                }
                            });
                            
                            // Submit the form
                            form.submit();
                        }
                    });
                }
            });

            // Replace the old showNotification function with SweetAlert
            function showNotification(message, type) {
                Swal.fire({
                    title: type === 'success' ? 'Success!' : 'Error!',
                    text: message,
                    icon: type,
                    toast: true,
                    position: 'top-end',
                    showConfirmButton: false,
                    timer: 3000,
                    timerProgressBar: true
                });
            }

            // Call this for messages
            {% if messages %}
                {% for message in messages %}
                    showNotification("{{ message }}", "{{ message.tags }}");
                {% endfor %}
            {% endif %}

            // Replace the number validation with SweetAlert
            const noInput = document.querySelector('[name="no"]');
            if (noInput) {
                // Create an array of existing numbers from the table
                const existingNumbers = Array.from(document.querySelectorAll('tbody tr')).map(
                    row => row.cells[0].textContent.trim()
                );

                noInput.addEventListener('change', function() {
                    const value = this.value.trim();
                    if (existingNumbers.includes(value)) {
                        this.classList.add('border-red-500');
                        Swal.fire({
                            title: 'Duplicate Record',
                            text: 'This record number already exists!',
                            icon: 'warning',
                            confirmButtonColor: '#3085d6'
                        });
                    } else {
                        this.classList.remove('border-red-500');
                    }
                });
            }

            // Show a toast notification for form submission
            if (form) {
                form.addEventListener('submit', function() {
                    // Show loading state
                    const submitButton = form.querySelector('button[type="submit"]');
                    submitButton.disabled = true;
                    submitButton.innerHTML = 'Saving...';
                });
            }

            const tradeName = document.querySelector('[name="trade_name"]');
            const permitNo = document.querySelector('[name="permit_no"]');

            // Validate trade name
            if (tradeName) {
                tradeName.addEventListener('blur', function() {
                    if (this.value.trim() === "") {
                        this.setCustomValidity('Trade name cannot be empty');
                    } else {
                        this.setCustomValidity('');
                    }
                });
            }

            // Validate permit number
            if (permitNo) {
                permitNo.addEventListener('blur', function() {
                    const permitValue = this.value.trim();
                    
                    // Check if the permit number is numeric
                    if (!/^\d+$/.test(permitValue)) {
                        this.setCustomValidity('Permit number must be numeric');
                    } else {
                        this.setCustomValidity('');
                    }
                });
            }

            // Date functionality - auto-set expiry date 3 months from issue date
            const dateIssued = document.querySelector('[name="date_issued"]');
            const expiryDate = document.querySelector('[name="expiry_date"]');
            
            if (dateIssued && expiryDate) {
                dateIssued.addEventListener('change', function() {
                    if (this.value) {
                        // Calculate expiry date (3 months from issue date)
                        const issued = new Date(this.value);
                        const expiry = new Date(issued);
                        expiry.setMonth(expiry.getMonth() + 3);
                        
                        // Format the date as YYYY-MM-DD for the input
                        const year = expiry.getFullYear();
                        const month = String(expiry.getMonth() + 1).padStart(2, '0');
                        const day = String(expiry.getDate()).padStart(2, '0');
                        expiryDate.value = `${year}-${month}-${day}`;
                        
                        // If the expiry date input is still in text mode, change it to date
                        expiryDate.type = 'date';
                        
                        // Show notification about expiry date
                        const expiryFormatted = expiry.toLocaleDateString('en-US', {
                            year: 'numeric',
                            month: 'long',
                            day: 'numeric'
                        });
                        
                        Swal.fire({
                            title: 'Expiry Date Set',
                            html: `The permit will expire on <strong>${expiryFormatted}</strong> (3 months from issue date).<br><br>You can adjust this date if needed.`,
                            icon: 'info',
                            confirmButtonText: 'OK',
                            confirmButtonColor: '#3085d6'
                        });
                    }
                });
                
                // Validate expiry date on change
                expiryDate.addEventListener('change', function() {
                    if (dateIssued.value && this.value) {
                        const issued = new Date(dateIssued.value);
                        const expiry = new Date(this.value);
                        
                        // Check if expiry is before issue date
                        if (expiry < issued) {
                            Swal.fire({
                                title: 'Invalid Date',
                                text: 'Expiry date cannot be earlier than date issued',
                                icon: 'error',
                                confirmButtonText: 'OK',
                                confirmButtonColor: '#3085d6'
                            });
                            
                            // Reset to 3 months from issue date
                            const newExpiry = new Date(issued);
                            newExpiry.setMonth(newExpiry.getMonth() + 3);
                            const year = newExpiry.getFullYear();
                            const month = String(newExpiry.getMonth() + 1).padStart(2, '0');
                            const day = String(newExpiry.getDate()).padStart(2, '0');
                            this.value = `${year}-${month}-${day}`;
                        }
                        
                        // Check if expiry is approaching (within 30 days)
                        const today = new Date();
                        const daysUntilExpiry = Math.ceil((expiry - today) / (1000 * 60 * 60 * 24));
                        
                        if (daysUntilExpiry <= 30 && daysUntilExpiry > 0) {
                            Swal.fire({
                                title: 'Expiry Warning',
                                html: `This permit will expire in <strong>${daysUntilExpiry} day${daysUntilExpiry !== 1 ? 's' : ''}</strong>.<br>Please ensure timely renewal.`,
                                icon: 'warning',
                                confirmButtonText: 'OK',
                                confirmButtonColor: '#3085d6'
                            });
                        } else if (daysUntilExpiry <= 0) {
                            Swal.fire({
                                title: 'Expired Permit',
                                text: 'This permit has already expired or will expire today. Please renew immediately.',
                                icon: 'error',
                                confirmButtonText: 'OK',
                                confirmButtonColor: '#3085d6'
                            });
                        }
                    }
                });
            }

            // Phone number validation
            const contactNo = document.querySelector('[name="contact_number"]');
            if (contactNo) {
                contactNo.addEventListener('input', function() {
                    // Remove any non-digit characters
                    this.value = this.value.replace(/\D/g, '');
                    
                    // Ensure it starts with '09'
                    if (this.value.length >= 2 && this.value.substring(0, 2) !== '09') {
                        this.value = '09' + this.value.substring(2);
                    }
                    
                    // Limit to 11 digits
                    if (this.value.length > 11) {
                        this.value = this.value.substring(0, 11);
                    }
                });
                
                // Add required attribute to ensure it's not empty
                contactNo.setAttribute('required', 'required');
            }

            // Enhanced search functionality
            const searchInput = document.getElementById('searchInput');
            const searchValidation = document.getElementById('searchValidation');
            
            if (searchInput) {
                let debounceTimer;

                searchInput.addEventListener('input', function() {
                    clearTimeout(debounceTimer);
                    
                    debounceTimer = setTimeout(() => {
                        const searchTerm = this.value.toLowerCase().trim();
                        const rows = document.querySelectorAll('tbody tr');
                        let visibleCount = 0;
                        
                        // Clear validation if search is empty
                        if (searchTerm === '') {
                            searchValidation.style.display = 'none';
                            rows.forEach(row => row.style.display = '');
                            return;
                        }

                        rows.forEach(row => {
                            // Get all cells in the row
                            const cells = row.querySelectorAll('td');
                            let shouldShow = false;
                            
                            cells.forEach(cell => {
                                const cellText = cell.textContent.toLowerCase().trim();
                                if (cellText.includes(searchTerm)) {
                                    shouldShow = true;
                                }
                            });
                            
                            row.style.display = shouldShow ? '' : 'none';
                            if (shouldShow) visibleCount++;
                        });
                        
                        // Update validation message with appropriate styling
                        if (visibleCount > 0) {
                            searchValidation.textContent = `Found ${visibleCount} matching record${visibleCount !== 1 ? 's' : ''}`;
                            searchValidation.className = 'absolute mt-1 text-sm font-medium text-green-600 bg-green-50 px-2 py-1 rounded-md';
                        } else {
                            searchValidation.textContent = 'No matches found';
                            searchValidation.className = 'absolute mt-1 text-sm font-medium text-red-600 bg-red-50 px-2 py-1 rounded-md';
                        }
                        searchValidation.style.display = 'block';
                    }, 300);
                });

                // Clear validation on focus if empty
                searchInput.addEventListener('focus', function() {
                    if (!this.value.trim()) {
                        searchValidation.style.display = 'none';
                    }
                });
            }

            // Convert date inputs to show placeholder
            const dateInputs = document.querySelectorAll('.date-input');
            
            dateInputs.forEach(input => {
                // Keep the input as text type initially to show placeholder
                input.type = 'text';
                
                input.addEventListener('focus', function() {
                    this.type = 'date';
                });
                
                input.addEventListener('blur', function() {
                    if (!this.value) {
                        this.type = 'text';
                    }
                });
            });

            // Quick Actions button functionality
            const userMenuButton = document.getElementById('user-menu-button');
            const userMenu = document.getElementById('user-menu');
            
            if (userMenuButton && userMenu) {
                userMenuButton.addEventListener('click', function(event) {
                    console.log('Button clicked'); // Debug line
                    event.stopPropagation();
                    userMenu.classList.toggle('hidden');
                });
                
                // Close the menu when clicking outside
                document.addEventListener('click', function(event) {
                    if (!userMenu.contains(event.target) && !userMenuButton.contains(event.target)) {
                        userMenu.classList.add('hidden');
                    }
                });
            }

            // Add SweetAlert confirmation for export
            window.exportTableToCSV = function(filename) {
                Swal.fire({
                    title: 'Export Data',
                    text: 'Do you want to export the table data to CSV?',
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonText: 'Yes, export it!',
                    cancelButtonText: 'Cancel',
                    confirmButtonColor: '#3085d6',
                    cancelButtonColor: '#d33'
                }).then((result) => {
                    if (result.isConfirmed) {
                        const table = document.querySelector('table');
                        const rows = table.querySelectorAll('tr');
                        let csv = [];
                        
                        for (let i = 0; i < rows.length; i++) {
                            const row = [], cols = rows[i].querySelectorAll('td, th');
                            
                            for (let j = 0; j < cols.length; j++) {
                                // Get the text content and clean it up
                                let data = cols[j].textContent.replace(/(\r\n|\n|\r)/gm, '').trim();
                                // Escape double quotes and wrap field in quotes
                                data = data.replace(/"/g, '""');
                                row.push('"' + data + '"');
                            }
                            csv.push(row.join(','));
                        }
                        
                        const csvString = csv.join('\n');
                        const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
                        const link = document.createElement('a');
                        if (navigator.msSaveBlob) {
                            navigator.msSaveBlob(blob, filename);
                        } else {
                            link.href = URL.createObjectURL(blob);
                            link.setAttribute('download', filename);
                            document.body.appendChild(link);
                            link.click();
                            document.body.removeChild(link);
                        }
                        
                        Swal.fire({
                            title: 'Exported!',
                            text: 'Your file has been exported successfully.',
                            icon: 'success',
                            timer: 2000,
                            showConfirmButton: false
                        });
                    }
                });
            }
            
            // Add SweetAlert for form reset confirmation
            const resetButton = form.querySelector('button[type="reset"]');
            if (resetButton) {
                resetButton.addEventListener('click', function(e) {
                    e.preventDefault();
                    Swal.fire({
                        title: 'Clear Form',
                        text: 'Are you sure you want to clear all form fields?',
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonText: 'Yes, clear it!',
                        cancelButtonText: 'Cancel',
                        confirmButtonColor: '#3085d6',
                        cancelButtonColor: '#d33'
                    }).then((result) => {
                        if (result.isConfirmed) {
                            form.reset();
                            Swal.fire({
                                title: 'Cleared!',
                                text: 'The form has been cleared.',
                                icon: 'success',
                                timer: 1500,
                                showConfirmButton: false
                            });
                        }
                    });
                });
            }
        });
    </script>
</body>
</html>