{% load static %}
{% load form_filters %}
{% load widget_tweaks %}

<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>CENRO Argao - Chainsaw Records</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
        <style>
            body {
                background-color: #f0fdf4;
                font-family: 'Inter', sans-serif;
            }
            
            .gradient-bg {
                background: linear-gradient(90deg, #22c55e 0%, #0ea5e9 100%);
                border-radius: 0.75rem;
                padding: 1.5rem;
            }
            
            .filter-button {
                padding: 0.5rem 1.5rem;
                border-radius: 2rem;
                font-weight: 500;
                transition: all 0.2s;
            }
            
            .filter-button.active {
                box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            }
            
            .filter-button:hover {
                transform: translateY(-1px);
            }
            
            .white-button {
                background-color: white;
                color: #3b82f6;
            }
            
            .green-button {
                background-color: #22c55e;
                color: white;
            }
            
            .red-button {
                background-color: #ef4444;
                color: white;
            }
            
            .yellow-button {
                background-color: #eab308;
                color: white;
            }
            
            .search-input {
                background-color: rgba(255, 255, 255, 0.2);
                border: none;
                color: white;
                padding: 0.75rem 1rem;
                border-radius: 0.5rem;
            }
            
            .search-input::placeholder {
                color: rgba(255, 255, 255, 0.7);
            }
            
            .date-input {
                background-color: rgba(255, 255, 255, 0.2);
                border: none;
                color: white;
                padding: 0.75rem 1rem;
                border-radius: 0.5rem;
                appearance: none;
            }
            
            .export-button {
                background-color: #15803d;
                color: white;
                padding: 0.75rem 1.5rem;
                border-radius: 0.5rem;
                display: flex;
                align-items: center;
                gap: 0.5rem;
                transition: all 0.2s;
            }
            
            .export-button:hover {
                background-color: #166534;
            }
            
            /* Style for date input calendar icon */
            input[type="date"]::-webkit-calendar-picker-indicator {
                filter: invert(1);
            }
            
            /* Style for select dropdown arrow */
            select {
                background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%23ffffff' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
                background-position: right 0.5rem center;
                background-repeat: no-repeat;
                background-size: 1.5em 1.5em;
            }

            /* Hover effects for different record statuses */
            .active-record:hover {
                background-color: #d1fae5; /* Light green */
            }

            .expiring-soon-record:hover {
                background-color: #fef3c7; /* Light orange */
            }

            .expired-record:hover {
                background-color: #fee2e2; /* Light red */
            }

            /* Active filter button styling */
            .filter-button-active {
                background-color: transparent !important;
                border: 2px solid white !important;
                color: white !important;
            }

            /* Add context menu styles */
            .context-menu {
                position: fixed;
                background: white;
                border: 1px solid #ccc;
                border-radius: 4px;
                box-shadow: 0 2px 5px rgba(0,0,0,0.2);
                padding: 8px 0;
                z-index: 1000;
            }

            .context-menu-item {
                padding: 8px 16px;
                cursor: pointer;
                display: flex;
                align-items: center;
                gap: 8px;
            }

            .context-menu-item:hover {
                background-color: #f3f4f6;
            }
        </style>
    </head>
<body>
<!-- Navigation Bar -->
<nav class="bg-transparent shadow-lg border-b border-gray-200">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex justify-between items-center h-16">
            <div class="flex items-center">
                <!-- Logo -->
                <div class="flex-shrink-0">
                    <span class="text-xl font-bold text-green-700">FUS-CENRO-ARGAO</span>
                </div>
            </div>
            <!-- User Menu -->
            <div class="hidden md:flex items-center space-x-4">
                <div class="text-lg text-gray-900 font-medium">
                    Welcome, {{ request.user.username }}
                </div>
                <div class="relative">
                    <button class="text-lg text-blue-600 hover:text-blue-800 transition duration-200 focus:outline-none" id="user-menu-button" aria-expanded="false" aria-haspopup="true">
                        â–¼
                    </button>
                    <div class="absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg z-20 hidden" id="user-menu">
                        <div class="py-1" role="menu" aria-orientation="vertical" aria-labelledby="user-menu-button">
                           
                            <!-- Quick Actions -->
                            <div class="px-4 py-2 text-sm text-black-800">Quick Actions</div>
                            <div class="grid grid-cols-1 gap-2">
                                <a href="{% url 'dashboard' %}" class="block px-4 py-2 text-sm text-green-700 hover:bg-gray-100">Dashboard</a>
                                <a href="{% url 'cutting' %}" class="block px-4 py-2 text-sm text-green-700 hover:bg-gray-100">Cutting Permits</a>
                                <a href="{% url 'lumber' %}" class="block px-4 py-2 text-sm text-green-700 hover:bg-gray-100">Lumber</a>
                                <a href="{% url 'chainsaw' %}" class="block px-4 py-2 text-sm text-green-700 hover:bg-gray-100">Chainsaw</a>
                                <a href="{% url 'wood' %}" class="block px-4 py-2 text-sm text-green-700 hover:bg-gray-100">WPP</a>
                            </div>
                            <a href="{% url 'logout' %}" class="block px-4 py-2 text-sm text-black-900 hover:bg-gray-100" role="menuitem">
                                <svg class="inline w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 12H8m8 0l-4-4m4 4l-4 4"></path>
                                </svg>
                                Sign Out
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Mobile Menu Button -->
            <div class="md:hidden">
                <button class="text-gray-500 hover:text-gray-700 focus:outline-none" id="mobile-menu-button">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path>
                    </svg>
                </button>
            </div>
        </div>
    </div>
    <!-- Mobile Menu -->
    <div class="md:hidden" id="mobile-menu" style="display: none;">
        <div class="px-2 pt-2 pb-3 space-y-1">
            <a href="{% url 'logout' %}" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Sign Out</a>
        </div>
    </div>
</nav>

<!-- Search Section -->
<div class="max-w-[95%] mx-auto px-4 sm:px-6 lg:px-8 pt-8">
    <div class="bg-gradient-to-r from-green-600 to-blue-400 p-6 rounded-xl shadow-lg">
        <!-- Filter Buttons Row -->
        <div class="flex gap-4 mb-6 flex-wrap">
            <button id="allRecordsBtn" 
                    class="px-6 py-2 bg-transparent text-white rounded-full transition-all duration-200 text-sm font-medium border-2 border-white">
                All Records
            </button>
            <button id="activeRecordsBtn" 
                    class="px-6 py-2 bg-green-500 hover:bg-green-600 text-white rounded-full transition-all duration-200 text-sm font-medium">
                Active
            </button>
            <button id="expiringSoonRecordsBtn" 
                    class="px-6 py-2 bg-yellow-500 hover:bg-yellow-600 text-white rounded-full transition-all duration-200 text-sm font-medium">
                To expire
            </button>
            <button id="expiredRecordsBtn" 
                    class="px-6 py-2 bg-red-500 hover:bg-red-600 text-white rounded-full transition-all duration-200 text-sm font-medium">
                Expired
            </button>
            
        </div>
        
        <!-- Search and filters row -->
        <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
            <!-- Search Record -->
            <div class="md:col-span-1">
                <label class="block text-white text-sm mb-2">Search Record</label>
                <input type="text" id="recordSearch" placeholder="Search record..." 
                       class="w-full px-4 py-2 rounded-lg bg-white/10 border border-white/20 text-white focus:outline-none focus:ring-2 focus:ring-emerald-400 focus:border-transparent">
            </div>
            
            <!-- Start Date -->
            <div class="md:col-span-1">
                <label class="block text-white text-sm mb-2">Start Date</label>
                <input type="date" id="startDate" class="w-full px-4 py-2 rounded-lg bg-white/10 border border-white/20 text-white focus:outline-none focus:ring-2 focus:ring-emerald-400 focus:border-transparent">
            </div>
            
            <!-- End Date -->
            <div class="md:col-span-1">
                <label class="block text-white text-sm mb-2">End Date</label>
                <input type="date" id="endDate" class="w-full px-4 py-2 rounded-lg bg-white/10 border border-white/20 text-white focus:outline-none focus:ring-2 focus:ring-emerald-400 focus:border-transparent">
            </div>
            
            <!-- Year Filter -->
            <div class="md:col-span-1">
                <label class="block text-white text-sm mb-2">Filter by Year</label>
                <select id="yearFilter" 
                        class="w-full px-4 py-2 rounded-lg bg-white/10 border border-white/20 text-black-500 focus:outline-none focus:ring-2 focus:ring-emerald-400 focus:border-transparent">
                    <option value="">All Years</option>
                </select>
            </div>
            
            <!-- Export Button -->
            <div class="md:col-span-1 flex items-end">
                <button onclick="exportTableToCSV('chainsaw_records.csv')" 
                        class="w-full px-4 py-2 bg-green-700 text-white rounded-lg hover:bg-green-800 flex items-center justify-center">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                    </svg>
                    Export
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Records Section - Full Width with Scroll -->
<div class="w-full py-4">
    <div class="table-container overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
            <thead>
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-black-500 uppercase tracking-wider">Reg. No.</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-black-500 uppercase tracking-wider">Year</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-black-500 uppercase tracking-wider">Region</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-black-500 uppercase tracking-wider">PENRO</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-black-500 uppercase tracking-wider">CENRO</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-black-500 uppercase tracking-wider">Owner</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-black-500 uppercase tracking-wider">Municipality</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-black-500 uppercase tracking-wider">Purpose</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-black-500 uppercase tracking-wider">Date Acquired</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-black-500 uppercase tracking-wider">Cert. Reg. No.</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-black-500 uppercase tracking-wider">CTPO No.</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-black-500 uppercase tracking-wider">Brand</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-black-500 uppercase tracking-wider">Model</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-black-500 uppercase tracking-wider">Serial No.</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-black-500 uppercase tracking-wider">Color</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-black-500 uppercase tracking-wider">Date Issued</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-black-500 uppercase tracking-wider">Expiry Date</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-black-500 uppercase tracking-wider">Reg. Status</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-black-500 uppercase tracking-wider">Date Renewal</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-black-500 uppercase tracking-wider">Horse Power</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-black-500 uppercase tracking-wider">Guidebar Length</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-black-500 uppercase tracking-wider">DENR Sticker</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-black-500 uppercase tracking-wider">File</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-black-500 uppercase tracking-wider">Actions</th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
                {% if chainsaw_records %}
                    {% for record in chainsaw_records %}
                    <tr class="hover:bg-gray-50" data-record-id="{{ record.id }}">
                        <td class="px-6 py-3 text-xs font-bold text-gray-900 whitespace-nowrap">{{ record.no }}</td>
                        <td class="px-6 py-3 text-xs text-gray-900 whitespace-nowrap">{{ record.year }}</td>
                        <td class="px-6 py-3 text-xs text-gray-900 whitespace-nowrap">{{ record.region }}</td>
                        <td class="px-6 py-3 text-xs text-gray-900 whitespace-nowrap">{{ record.penro }}</td>
                        <td class="px-6 py-3 text-xs text-gray-900 whitespace-nowrap">{{ record.cenro }}</td>
                        <td class="px-6 py-3 text-xs text-gray-900 whitespace-nowrap">{{ record.name }}</td>
                        <td class="px-6 py-3 text-xs text-gray-900 whitespace-nowrap">{{ record.municipality }}</td>
                        <td class="px-6 py-3 text-xs text-gray-900 whitespace-nowrap">{{ record.purpose }}</td>
                        <td class="px-6 py-3 text-xs text-gray-900 whitespace-nowrap">{{ record.date_acquired|date:"M d, Y" }}</td>
                        <td class="px-6 py-3 text-xs text-gray-900 whitespace-nowrap">{{ record.cert_reg_number }}</td>
                        <td class="px-6 py-3 text-xs text-gray-900 whitespace-nowrap">{{ record.ctpo_number }}</td>
                        <td class="px-6 py-3 text-xs text-gray-900 whitespace-nowrap">{{ record.brand }}</td>
                        <td class="px-6 py-3 text-xs text-gray-900 whitespace-nowrap">{{ record.model }}</td>
                        <td class="px-6 py-3 text-xs text-gray-900 whitespace-nowrap">{{ record.serial_number }}</td>
                        <td class="px-6 py-3 text-xs text-gray-900 whitespace-nowrap">{{ record.color }}</td>
                        <td class="px-6 py-3 text-xs text-gray-900 whitespace-nowrap">{{ record.date_issued|date:"M d, Y" }}</td>
                        <td class="px-6 py-3 text-xs text-gray-900 whitespace-nowrap">{{ record.expiry_date|date:"M d, Y" }}</td>
                        <td class="px-6 py-3 text-xs text-gray-900 whitespace-nowrap">{{ record.registration_status }}</td>
                        <td class="px-6 py-3 text-xs text-gray-900 whitespace-nowrap">
                            {% if record.date_renewal %}
                                {{ record.date_renewal|date:"M d, Y" }}
                            {% else %}
                                -
                            {% endif %}
                        </td>
                        <td class="px-6 py-3 text-xs  text-gray-900 whitespace-nowrap">{{ record.horse_power }}</td>
                        <td class="px-6 py-3 text-xs  text-gray-900 whitespace-nowrap">{{ record.guidebar_length }}</td>
                        <td class="px-6 py-3 text-xs text-gray-900 whitespace-nowrap">{{ record.denr_sticker }}</td>
                        <td class="px-6 py-3 text-xs text-gray-900 whitespace-nowrap">
                            {% if record.file %}
                                <a href="{{ record.file.url }}" class="text-blue-600 hover:text-blue-900" target="_blank">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10"></path>
                                </svg>
                                View
                            </a>
                            {% else %}
                                <span class="text-gray-400">No file</span>
                            {% endif %}
                        </td>
                        <td class="px-6 py-3 text-xs font-bold text-gray-900 whitespace-nowrap">
                            <div class="flex space-x-2">
                                <a href="{% url 'view_chainsaw' record.id %}" class="text-blue-600 hover:text-blue-900">View</a>
                                <a href="{% url 'edit_chainsaw' record.id %}" class="text-orange-600 hover:text-orange-900">Edit</a>
                                {% if record.is_expired %}
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                {% else %}
                    <tr id="noRecordsRow">
                        <td colspan="24" class="px-6 py-4 text-center text-gray-500">No records found matching your criteria.</td>
                    </tr>
                {% endif %}
            </tbody>
        </table>
    </div>
</div>

<footer class="bg-blue-900 text-white py-8">
    <div class="max-w-7xl mx-auto text-center">
        <p class="text-sm">&copy; 2025 Department of Environment and Natural Resources. All rights reserved.</p>
        <p class="text-sm mt-1">CENRO ARGAO | Argao, Cebu</p>
    </div>
</footer>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM loaded, initializing toggle menu functionality');
        
        // User menu dropdown toggle
        const userMenuButton = document.getElementById('user-menu-button');
        const userMenu = document.getElementById('user-menu');
        
        if (userMenuButton && userMenu) {
            console.log('User menu elements found');
            
            userMenuButton.addEventListener('click', function(event) {
                event.preventDefault();
                event.stopPropagation();
                
                // Toggle the 'hidden' class
                if (userMenu.classList.contains('hidden')) {
                    userMenu.classList.remove('hidden');
                    console.log('User menu opened');
                } else {
                    userMenu.classList.add('hidden');
                    console.log('User menu closed');
                }
            });
            
            // Close the menu when clicking outside
            document.addEventListener('click', function(event) {
                if (!userMenuButton.contains(event.target) && !userMenu.contains(event.target)) {
                    userMenu.classList.add('hidden');
                }
            });
        } else {
            console.error('User menu elements not found:', {
                userMenuButton: !!userMenuButton,
                userMenu: !!userMenu
            });
        }
        
        // Mobile menu toggle
        const mobileMenuButton = document.getElementById('mobile-menu-button');
        const mobileMenu = document.getElementById('mobile-menu');
        
        if (mobileMenuButton && mobileMenu) {
            console.log('Mobile menu elements found');
            
            mobileMenuButton.addEventListener('click', function(event) {
                event.preventDefault();
                event.stopPropagation();
                
                // Toggle the display style directly
                if (mobileMenu.style.display === 'none' || mobileMenu.style.display === '') {
                    mobileMenu.style.display = 'block';
                    console.log('Mobile menu opened');
                } else {
                    mobileMenu.style.display = 'none';
                    console.log('Mobile menu closed');
                }
            });
        } else {
            console.error('Mobile menu elements not found:', {
                mobileMenuButton: !!mobileMenuButton,
                mobileMenu: !!mobileMenu
            });
        }
    });
</script>

<!-- Add this JavaScript to improve the year filter functionality -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM loaded, initializing year filter functionality');
        
        // Year filter functionality
        const yearFilter = document.getElementById('yearFilter');
        const tableBody = document.querySelector('tbody');
        
        if (yearFilter && tableBody) {
            console.log('Year filter and table body found');
            
            // Clear existing options first
            while (yearFilter.options.length > 1) {
                yearFilter.remove(1);
            }
            
            // Get current year
            const currentYear = new Date().getFullYear();
            
            // Add years from 2010 to current year in descending order
            for (let year = currentYear; year >= 2010; year--) {
                const option = document.createElement('option');
                option.value = year.toString();
                option.textContent = year.toString();
                yearFilter.appendChild(option);
            }
            
            console.log('Year filter populated with years from 2010 to', currentYear);
            
            // Add event listener for year filter change
            yearFilter.addEventListener('change', function() {
                const selectedYear = this.value;
                console.log('Year filter changed to:', selectedYear);
                
                // Get all rows except the "No records found" row
                const rows = Array.from(tableBody.querySelectorAll('tr:not(#noRecordsRow)'));
                let visibleRowCount = 0;
                
                rows.forEach(row => {
                    // Skip if it's a "No records found" row
                    if (row.querySelector('td[colspan]') && row.id !== 'noRecordsRow') {
                        return;
                    }
                    
                    // If no year selected, show all rows
                    if (!selectedYear) {
                        row.style.display = '';
                        visibleRowCount++;
                        return;
                    }
                    
                    // Check issued date column (column 16)
                    const issuedDateCell = row.querySelector('td:nth-child(16)');
                    if (issuedDateCell) {
                        const dateText = issuedDateCell.textContent.trim();
                        // Extract year from date format like "Jan 15, 2023"
                        const match = dateText.match(/\d{4}$/);
                        if (match && match[0] === selectedYear) {
                            row.style.display = '';
                            visibleRowCount++;
                            console.log('Showing row with issued date year:', selectedYear);
                        } else {
                            row.style.display = 'none';
                        }
                    } else {
                        row.style.display = 'none';
                    }
                });
                
                console.log('Visible rows after year filtering:', visibleRowCount);
                
                // Show "No records found" row if no matches
                const noRecordsRow = document.getElementById('noRecordsRow');
                if (noRecordsRow) {
                    if (visibleRowCount === 0 && selectedYear !== '') {
                        noRecordsRow.style.display = '';
                        console.log('Showing no records message');
                    } else {
                        noRecordsRow.style.display = 'none';
                        console.log('Hiding no records message');
                    }
                }
            });
            
            console.log('Year filter event listener added');
        } else {
            console.error('Year filter elements not found:', {
                yearFilter: !!yearFilter,
                tableBody: !!tableBody
            });
        }
    });
</script>

<!-- Add this JavaScript to fix the filter buttons functionality -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM loaded, initializing filter buttons functionality');
        
        // Get filter buttons
        const allRecordsBtn = document.getElementById('allRecordsBtn');
        const activeRecordsBtn = document.getElementById('activeRecordsBtn');
        const expiredRecordsBtn = document.getElementById('expiredRecordsBtn');
        const expiringSoonRecordsBtn = document.getElementById('expiringSoonRecordsBtn');
        
        // Get table body
        const tableBody = document.querySelector('tbody');
        
        if (!tableBody) {
            console.error('Table body not found!');
            return;
        }
        
        // Helper function to highlight the active button
        function highlightActiveButton(activeButton) {
            // Remove highlight from all buttons
            [allRecordsBtn, activeRecordsBtn, expiredRecordsBtn, expiringSoonRecordsBtn].forEach(btn => {
                if (btn) {
                    btn.classList.remove('filter-button-active');
                }
            });

            // Add highlight to active button
            activeButton.classList.add('filter-button-active');
        }
        
        // All Records button
        if (allRecordsBtn) {
            allRecordsBtn.addEventListener('click', function() {
                console.log('All Records button clicked');
                
                // Show all rows
                const rows = tableBody.querySelectorAll('tr:not(#noRecordsRow)');
                rows.forEach(row => {
                    row.style.display = '';
                });
                
                // Hide "No records found" row
                const noRecordsRow = document.getElementById('noRecordsRow');
                if (noRecordsRow) {
                    noRecordsRow.style.display = 'none';
                }
                
                // Highlight this button
                highlightActiveButton(allRecordsBtn);
            });
        }
        
        // Active Records button
        if (activeRecordsBtn) {
            activeRecordsBtn.addEventListener('click', function() {
                console.log('Active Records button clicked');
                
                const rows = tableBody.querySelectorAll('tr:not(#noRecordsRow)');
                const today = new Date();
                const threeMonthsLater = new Date();
                threeMonthsLater.setMonth(today.getMonth() + 3);
                let visibleRowCount = 0;
                
                rows.forEach(row => {
                    // Skip if it's a "No records found" row
                    if (row.querySelector('td[colspan]')) {
                        return;
                    }
                    
                    // Get the Expiry Date cell (column 17)
                    const expiryDateCell = row.querySelector('td:nth-child(17)');
                    
                    if (expiryDateCell) {
                        const expiryDateText = expiryDateCell.textContent.trim();
                        
                        if (expiryDateText) {
                            // Parse the expiry date (format: "Jan 15, 2023")
                            const expiryDate = new Date(expiryDateText);
                            
                            // Check if the date is valid and more than 3 months in the future (active)
                            if (!isNaN(expiryDate.getTime()) && expiryDate > threeMonthsLater) {
                                row.style.display = '';
                                visibleRowCount++;
                                console.log('Showing active row with expiry date:', expiryDateText);
                            } else {
                                row.style.display = 'none';
                                console.log('Hiding inactive row with expiry date:', expiryDateText);
                            }
                        } else {
                            row.style.display = 'none';
                            console.log('Hiding row - no expiry date');
                        }
                    } else {
                        row.style.display = 'none';
                        console.log('Hiding row - no expiry date cell');
                    }
                });
                
                console.log('Total visible rows after filtering:', visibleRowCount);
                
                // Show "No records found" row if no matches
                const noRecordsRow = document.getElementById('noRecordsRow');
                if (noRecordsRow) {
                    if (visibleRowCount === 0) {
                        noRecordsRow.style.display = '';
                        console.log('Showing no records message');
                    } else {
                        noRecordsRow.style.display = 'none';
                        console.log('Hiding no records message');
                    }
                }
                
                // Highlight this button
                highlightActiveButton(activeRecordsBtn);
            });
        }
        
        // Expired Records button
        if (expiredRecordsBtn) {
            expiredRecordsBtn.addEventListener('click', function() {
                console.log('Expired Records button clicked');
                
                const rows = tableBody.querySelectorAll('tr:not(#noRecordsRow)');
                const today = new Date();
                let visibleRowCount = 0;
                
                rows.forEach(row => {
                    // Skip if it's a "No records found" row
                    if (row.querySelector('td[colspan]')) {
                        return;
                    }
                    
                    // Get the Expiry Date cell (column 17)
                    const expiryDateCell = row.querySelector('td:nth-child(17)');
                    
                    if (expiryDateCell) {
                        const expiryDateText = expiryDateCell.textContent.trim();
                        
                        if (expiryDateText) {
                            // Parse the expiry date (format: "Jan 15, 2023")
                            const expiryDate = new Date(expiryDateText);
                            
                            // Check if the date is valid and in the past (expired)
                            if (!isNaN(expiryDate.getTime()) && expiryDate < today) {
                                row.style.display = '';
                                visibleRowCount++;
                                console.log('Showing expired row with expiry date:', expiryDateText);
                            } else {
                                row.style.display = 'none';
                                console.log('Hiding non-expired row with expiry date:', expiryDateText);
                            }
                        } else {
                            row.style.display = 'none';
                            console.log('Hiding row - no expiry date');
                        }
                    } else {
                        row.style.display = 'none';
                        console.log('Hiding row - no expiry date cell');
                    }
                });
                
                console.log('Total visible rows after filtering:', visibleRowCount);
                
                // Show "No records found" row if no matches
                const noRecordsRow = document.getElementById('noRecordsRow');
                if (noRecordsRow) {
                    if (visibleRowCount === 0) {
                        noRecordsRow.style.display = '';
                        console.log('Showing no records message');
                    } else {
                        noRecordsRow.style.display = 'none';
                        console.log('Hiding no records message');
                    }
                }
                
                // Highlight this button
                highlightActiveButton(expiredRecordsBtn);
            });
        }
        
        // Expiring Soon Records button
        if (expiringSoonRecordsBtn) {
            expiringSoonRecordsBtn.addEventListener('click', function() {
                console.log('Expiring Soon Records button clicked');
                
                const rows = tableBody.querySelectorAll('tr:not(#noRecordsRow)');
                const today = new Date();
                const threeMonthsLater = new Date();
                threeMonthsLater.setMonth(today.getMonth() + 3);
                
                console.log('Date range for expiring soon:', 
                    today.toISOString().split('T')[0], 'to', 
                    threeMonthsLater.toISOString().split('T')[0]);
                
                let visibleRowCount = 0;
                
                rows.forEach(row => {
                    // Skip if it's a "No records found" row
                    if (row.querySelector('td[colspan]')) {
                        return;
                    }
                    
                    // Get the Expiry Date cell (column 17)
                    const expiryDateCell = row.querySelector('td:nth-child(17)');
                    
                    if (expiryDateCell) {
                        const expiryDateText = expiryDateCell.textContent.trim();
                        
                        if (expiryDateText) {
                            // Parse the expiry date (format: "Jan 15, 2023")
                            const expiryDate = new Date(expiryDateText);
                            
                            // Check if the date is valid and within the next 3 months
                            if (!isNaN(expiryDate.getTime()) && 
                                expiryDate >= today && 
                                expiryDate <= threeMonthsLater) {
                                row.style.display = '';
                                visibleRowCount++;
                                console.log('Showing expiring soon row with expiry date:', expiryDateText);
                            } else {
                                row.style.display = 'none';
                                console.log('Hiding row - not expiring soon with expiry date:', expiryDateText);
                            }
                        } else {
                            row.style.display = 'none';
                            console.log('Hiding row - no expiry date');
                        }
                    } else {
                        row.style.display = 'none';
                        console.log('Hiding row - no expiry date cell');
                    }
                });
                
                console.log('Total visible rows after filtering:', visibleRowCount);
                
                // Show "No records found" row if no matches
                const noRecordsRow = document.getElementById('noRecordsRow');
                if (noRecordsRow) {
                    if (visibleRowCount === 0) {
                        noRecordsRow.style.display = '';
                        console.log('Showing no records message');
                    } else {
                        noRecordsRow.style.display = 'none';
                        console.log('Hiding no records message');
                    }
                }
                
                // Highlight this button
                highlightActiveButton(expiringSoonRecordsBtn);
            });
        }
        
        // Create "No records found" row if it doesn't exist
        let noRecordsRow = document.getElementById('noRecordsRow');
        if (!noRecordsRow) {
            noRecordsRow = document.createElement('tr');
            noRecordsRow.id = 'noRecordsRow';
            noRecordsRow.style.display = 'none'; // Hidden by default
            
            const noRecordsCell = document.createElement('td');
            noRecordsCell.colSpan = document.querySelector('thead tr').children.length;
            noRecordsCell.className = 'px-6 py-8 text-center text-gray-500';
            noRecordsCell.textContent = 'No records found matching your criteria.';
            
            noRecordsRow.appendChild(noRecordsCell);
            tableBody.appendChild(noRecordsRow);
            console.log('Created "No records found" row');
        }
        
        // Highlight the "All Records" button by default
        if (allRecordsBtn) {
            highlightActiveButton(allRecordsBtn);
        }
        
        console.log('Filter buttons functionality initialized');
    });
</script>

<!-- Add this JavaScript for date range filtering -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM loaded, initializing date range filter functionality');
        
        // Get date filter inputs
        const startDateInput = document.getElementById('startDate');
        const endDateInput = document.getElementById('endDate');
        const tableBody = document.querySelector('tbody');
        
        if (startDateInput && endDateInput && tableBody) {
            console.log('Date filter inputs and table body found');
            
            // Set default values to current date and 7 days later
            const today = new Date();
            const defaultEndDate = new Date();
            defaultEndDate.setDate(today.getDate() + 7);
            
            // Format date as YYYY-MM-DD for input value
            function formatDateForInput(date) {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            }
            
            // Set default values
            startDateInput.value = formatDateForInput(today);
            endDateInput.value = formatDateForInput(defaultEndDate);
            
            // Function to apply date filtering
            function applyDateFilter() {
                const startDate = startDateInput.value ? new Date(startDateInput.value) : null;
                const endDate = endDateInput.value ? new Date(endDateInput.value) : null;
                
                if (!startDate && !endDate) {
                    console.log('No date range specified, showing all records');
                    return;
                }
                
                console.log('Filtering by date range:', 
                    startDate ? startDate.toISOString().split('T')[0] : 'any', 
                    'to', 
                    endDate ? endDate.toISOString().split('T')[0] : 'any');
                
                // Set time to end of day for end date to include the entire day
                if (endDate) {
                    endDate.setHours(23, 59, 59, 999);
                }
                
                const rows = tableBody.querySelectorAll('tr:not(#noRecordsRow)');
                let visibleRowCount = 0;
                
                rows.forEach(row => {
                    // Skip if it's a "No records found" row
                    if (row.querySelector('td[colspan]')) {
                        return;
                    }
                    
                    // Get the Date Issued cell (column 16)
                    const issuedDateCell = row.querySelector('td:nth-child(16)');
                    
                    if (issuedDateCell) {
                        const issuedDateText = issuedDateCell.textContent.trim();
                        
                        if (issuedDateText) {
                            // Parse the issued date (format: "Jan 15, 2023")
                            const issuedDate = new Date(issuedDateText);
                            
                            if (!isNaN(issuedDate.getTime())) {
                                let showRow = true;
                                
                                // Check if date is within range
                                if (startDate && issuedDate < startDate) {
                                    showRow = false;
                                }
                                
                                if (endDate && issuedDate > endDate) {
                                    showRow = false;
                                }
                                
                                if (showRow) {
                                    row.style.display = '';
                                    visibleRowCount++;
                                    console.log('Showing row with issued date:', issuedDateText);
                                } else {
                                    row.style.display = 'none';
                                    console.log('Hiding row - date out of range:', issuedDateText);
                                }
                            } else {
                                console.log('Invalid date format:', issuedDateText);
                                row.style.display = 'none';
                            }
                        } else {
                            console.log('Empty date cell');
                            row.style.display = 'none';
                        }
                    } else {
                        console.log('Date cell not found');
                        row.style.display = 'none';
                    }
                });
                
                console.log('Total visible rows after date filtering:', visibleRowCount);
                
                // Show "No records found" row if no matches
                const noRecordsRow = document.getElementById('noRecordsRow');
                if (noRecordsRow) {
                    if (visibleRowCount === 0) {
                        noRecordsRow.style.display = '';
                        console.log('Showing no records message');
                    } else {
                        noRecordsRow.style.display = 'none';
                        console.log('Hiding no records message');
                    }
                }
            }
            
            // Add event listeners for date inputs
            startDateInput.addEventListener('change', applyDateFilter);
            endDateInput.addEventListener('change', applyDateFilter);
            
            // Add event listeners for date picker icons if they exist
            const startDateIcon = document.querySelector('[data-start-date-icon]');
            const endDateIcon = document.querySelector('[data-end-date-icon]');
            
            if (startDateIcon) {
                startDateIcon.addEventListener('click', function() {
                    startDateInput.showPicker();
                });
            }
            
            if (endDateIcon) {
                endDateIcon.addEventListener('click', function() {
                    endDateInput.showPicker();
                });
            }
            
            console.log('Date filter event listeners added');
        } else {
            console.error('Date filter elements not found:', {
                startDateInput: !!startDateInput,
                endDateInput: !!endDateInput,
                tableBody: !!tableBody
            });
        }
    });
</script>

<!-- Add this JavaScript to apply status-based classes to rows -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM loaded, applying status-based styling to rows');
        
        // Apply status classes to rows based on expiry date
        function applyStatusClasses() {
            const rows = document.querySelectorAll('tbody tr:not(#noRecordsRow)');
            const today = new Date();
            const threeMonthsLater = new Date();
            threeMonthsLater.setMonth(today.getMonth() + 3);
            
            console.log('Applying status classes to rows. Today:', today.toISOString().split('T')[0], 
                        'Three months later:', threeMonthsLater.toISOString().split('T')[0]);
            
            rows.forEach(row => {
                // Skip if it's a "No records found" row
                if (row.querySelector('td[colspan]')) {
                    return;
                }
                
                // Get the expiry date cell (column 17)
                const expiryDateCell = row.querySelector('td:nth-child(17)');
                
                if (expiryDateCell) {
                    const expiryDateText = expiryDateCell.textContent.trim();
                    
                    if (expiryDateText) {
                        // Parse the expiry date (format: "Jan 15, 2023")
                        const expiryDate = new Date(expiryDateText);
                        
                        if (!isNaN(expiryDate.getTime())) {
                            // Remove any existing status classes
                            row.classList.remove('active-record', 'expired-record', 'expiring-soon-record');
                            
                            // Apply appropriate class based on date
                            if (expiryDate < today) {
                                // Expired
                                row.classList.add('expired-record');
                                console.log('Row marked as expired:', expiryDateText);
                            } else if (expiryDate <= threeMonthsLater) {
                                // Expiring soon (within 3 months)
                                row.classList.add('expiring-soon-record');
                                console.log('Row marked as expiring soon:', expiryDateText);
                            } else {
                                // Active
                                row.classList.add('active-record');
                                console.log('Row marked as active:', expiryDateText);
                            }
                        }
                    }
                }
            });
        }
        
        // Apply status classes when page loads
        applyStatusClasses();
        
        // Apply status classes after any filtering
        const filterButtons = [
            document.getElementById('allRecordsBtn'),
            document.getElementById('activeRecordsBtn'),
            document.getElementById('expiredRecordsBtn'),
            document.getElementById('expiringSoonRecordsBtn'),
            document.getElementById('yearFilter')
        ];
        
        filterButtons.forEach(button => {
            if (button) {
                button.addEventListener('click', function() {
                    setTimeout(applyStatusClasses, 10);
                });
            }
        });
        
        // Apply status classes after search
        const searchInput = document.getElementById('recordSearch');
        if (searchInput) {
            searchInput.addEventListener('input', function() {
                setTimeout(applyStatusClasses, 10);
            });
        }
    });
</script>

<!-- Add this JavaScript to initialize search functionality -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM loaded, initializing search functionality');
        
        // Get the search input element
        const searchInput = document.querySelector('input[placeholder="Search record..."]');
        const tableBody = document.querySelector('tbody');
        
        if (searchInput && tableBody) {
            console.log('Search input and table body found');
            
            searchInput.addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase().trim();
                console.log('Searching for:', searchTerm);
                
                // Get all rows except the "No records found" row
                const rows = Array.from(tableBody.querySelectorAll('tr:not(#noRecordsRow)'));
                let visibleRowCount = 0;
                
                rows.forEach(row => {
                    // Skip if it's a "No records found" row with colspan
                    if (row.querySelector('td[colspan]')) {
                        return;
                    }
                    
                    // Get all cells in the row
                    const cells = Array.from(row.querySelectorAll('td'));
                    
                    // If search term is empty, show all rows
                    if (!searchTerm) {
                        row.style.display = '';
                        visibleRowCount++;
                        return;
                    }
                    
                    // Check if any cell contains the search term
                    const rowText = cells.map(cell => cell.textContent.toLowerCase()).join(' ');
                    if (rowText.includes(searchTerm)) {
                        row.style.display = '';
                        visibleRowCount++;
                        console.log('Row matches search term');
                    } else {
                        row.style.display = 'none';
                        console.log('Row does not match search term');
                    }
                });
                
                console.log('Total visible rows after search:', visibleRowCount);
                
                // Show "No records found" row if no matches
                const noRecordsRow = document.getElementById('noRecordsRow');
                if (noRecordsRow) {
                    if (visibleRowCount === 0 && searchTerm) {
                        noRecordsRow.style.display = '';
                        console.log('Showing no records message');
                    } else {
                        noRecordsRow.style.display = 'none';
                        console.log('Hiding no records message');
                    }
                }
            });
            
            // Add clear search button functionality if it exists
            const clearSearchButton = document.querySelector('.clear-search-button');
            if (clearSearchButton) {
                clearSearchButton.addEventListener('click', function() {
                    searchInput.value = '';
                    // Trigger the input event to refresh the table
                    searchInput.dispatchEvent(new Event('input'));
                });
            }
            
            console.log('Search functionality initialized');
        } else {
            console.error('Search elements not found:', {
                searchInput: !!searchInput,
                tableBody: !!tableBody
            });
        }
    });
</script>

<!-- Add this script or modify your existing exportTableToCSV function -->
<script>
    // Function to export only visible table rows to CSV
    function exportTableToCSV(filename) {
        console.log('Exporting visible table rows to CSV');
        
        const table = document.querySelector('table');
        if (!table) {
            console.error('Table not found for export');
            return;
        }
        
        // Get header row
        const headerRow = table.querySelector('thead tr');
        if (!headerRow) {
            console.error('Table header row not found');
            return;
        }
        
        // Get all visible rows from tbody (excluding the "No records found" row)
        const visibleRows = Array.from(table.querySelectorAll('tbody tr')).filter(row => {
            // Only include rows that are currently visible and not the "No records found" row
            return row.style.display !== 'none' && !row.querySelector('td[colspan]');
        });
        
        console.log(`Found ${visibleRows.length} visible rows to export`);
        
        if (visibleRows.length === 0) {
            alert('No records to export. Please adjust your filters to show some records first.');
            return;
        }
        
        let csv = [];
        
        // Add header row
        const headerCells = headerRow.querySelectorAll('th');
        const headerData = [];
        headerCells.forEach(cell => {
            // Clean and format the header text
            let text = cell.textContent.replace(/(\r\n|\n|\r)/gm, '').trim();
            text = text.replace(/"/g, '""'); // Escape double quotes
            headerData.push(`"${text}"`);
        });
        csv.push(headerData.join(','));
        
        // Add data rows
        visibleRows.forEach(row => {
            const cells = row.querySelectorAll('td');
            const rowData = [];
            
            cells.forEach(cell => {
                // Clean and format the cell text
                let text = cell.textContent.replace(/(\r\n|\n|\r)/gm, '').trim();
                text = text.replace(/"/g, '""'); // Escape double quotes
                rowData.push(`"${text}"`);
            });
            
            csv.push(rowData.join(','));
        });
        
        // Create and download the CSV file
        const csvString = csv.join('\n');
        const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
        
        // Create download link
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        
        link.setAttribute('href', url);
        link.setAttribute('download', filename);
        link.style.visibility = 'hidden';
        
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        console.log('CSV export complete');
    }
    
    // Make sure the export button uses this function
    document.addEventListener('DOMContentLoaded', function() {
        const exportButton = document.getElementById('exportButton');
        if (exportButton) {
            exportButton.addEventListener('click', function() {
                // Generate filename with current date
                const today = new Date();
                const formattedDate = today.toISOString().split('T')[0]; // YYYY-MM-DD format
                exportTableToCSV(`chainsaw_records_${formattedDate}.csv`);
            });
            console.log('Export button event listener added');
        }
    });
</script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Add context menu element to the body
        const contextMenu = document.createElement('div');
        contextMenu.className = 'context-menu hidden';
        contextMenu.innerHTML = `
            <div class="context-menu-item" id="view-option">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                </svg>
                View
            </div>
            <div class="context-menu-item" id="edit-option">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                </svg>
                Edit
            </div>
        `;
        document.body.appendChild(contextMenu);

        // Handle double click on table rows
        const tableRows = document.querySelectorAll('tbody tr');
        tableRows.forEach(row => {
            row.addEventListener('dblclick', function(e) {
                if (row.querySelector('td[colspan]')) return;

                e.preventDefault();
                
                const recordId = this.dataset.recordId || 
                               this.querySelector('a[href*="/view/"]')?.href?.match(/\d+/)?.[0] ||
                               this.querySelector('a[href*="/edit/"]')?.href?.match(/\d+/)?.[0];
                
                if (!recordId) return;

                contextMenu.style.left = `${e.pageX}px`;
                contextMenu.style.top = `${e.pageY}px`;
                contextMenu.classList.remove('hidden');

                const viewOption = document.getElementById('view-option');
                const editOption = document.getElementById('edit-option');

                viewOption.onclick = () => window.location.href = `/chainsaw/${recordId}/view/`;
                editOption.onclick = () => window.location.href = `/edit-chainsaw/${recordId}/`;
            });
        });

        // Hide context menu when clicking outside
        document.addEventListener('click', function(e) {
            if (!contextMenu.contains(e.target)) {
                contextMenu.classList.add('hidden');
            }
        });
    });
</script>
</body>
</html>
